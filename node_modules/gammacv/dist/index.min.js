/**
 * GammaCV v0.5.3
 * @license MIT
 * @author Arkadiy Pilguk(apilguk@gmail.com)
 * @author Mihail Zachepilo(mihailzachepilo@gmail.com)
 * Copyright 2018-2023 Peculiar Ventures.
 * All rights reserved.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GammaCV={})}(this,(function(t){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,(r=a.key,i=void 0,"symbol"==typeof(i=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var a=n.call(t,e||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(r,"string"))?i:String(i)),a)}var r,i}function r(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&s(t,e)}function o(t){return o=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},o(t)}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function u(t,e,n){return u=l()?Reflect.construct.bind():function(t,e,n){var a=[null];a.push.apply(a,e);var r=new(Function.bind.apply(t,a));return n&&s(r,n.prototype),r},u.apply(null,arguments)}function c(t){var e="function"==typeof Map?new Map:void 0;return c=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,a)}function a(){return u(t,arguments,o(this).constructor)}return a.prototype=Object.create(t.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),s(a,t)},c(t)}function h(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function f(t){var e=l();return function(){var n,a=o(t);if(e){var r=o(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return h(this,n)}}function d(t){return function(t){if(Array.isArray(t))return p(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return p(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}var v=function(){function t(e){n(this,t),this.id=t.GlobalCountIncrease(),this.name="".concat(e,":").concat(this.id)}return r(t,null,[{key:"GlobalCountIncrease",value:function(){return t.GlobalNodesCount+=1,t.GlobalNodesCount}}]),t}();v.GlobalNodesCount=0;var y=function(){function t(e,a,r,i){n(this,t),this.gl=e,this.name=r,this.dtype=i,this.location=e.getUniformLocation(a,this.name)}return r(t,[{key:"set",value:function(t){var e=this.gl;switch(this.dtype){case"int":e.uniform1i(this.location,t);break;case"float":e.uniform1f(this.location,t);break;case"vec2":e.uniform2fv(this.location,t);break;case"vec3":e.uniform3fv(this.location,t);break;case"vec4":e.uniform4fv(this.location,t);break;case"mat3":e.uniformMatrix3fv(this.location,!1,t);break;case"mat4":e.uniformMatrix4fv(this.location,!1,t);break;default:return!1}return!0}}]),t}(),g=function(){function t(e,a,r,i){n(this,t),this.program=a,this.gl=e,this.name=r,this.dtype=i,this.location=e.getAttribLocation(this.program,this.name),this.ctx=e.createBuffer(),this.empty=new ArrayBuffer(1),"float"===i||"int"===i?this.size=1:(this.size=parseInt(/\d/g.exec(i)[0],10),e.enableVertexAttribArray(this.location))}return r(t,[{key:"set",value:function(t){var e=this.gl;this.bind(this.ctx),"int"===this.dtype?e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),e.STATIC_DRAW):e.bufferData(e.ARRAY_BUFFER,new Float32Array(t),e.STATIC_DRAW)}},{key:"bind",value:function(){var t=this.gl;"int"===this.dtype?t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.ctx):(t.bindBuffer(t.ARRAY_BUFFER,this.ctx),t.vertexAttribPointer(this.location,this.size,t.FLOAT,!1,0,0))}},{key:"unbind",value:function(){var t=this.gl;"int"===this.dtype?t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null):(t.bindBuffer(t.ARRAY_BUFFER,null),t.vertexAttribPointer(this.location,this.size,t.FLOAT,!1,0,0))}},{key:"disable",value:function(){this.gl.disableVertexAttribArray(this.ctx)}},{key:"enable",value:function(){this.gl.enableVertexAttribArray(this.ctx)}},{key:"delete",value:function(){this.gl.deleteBuffer(this.ctx),this.program=null,this.gl=null,this.ctx=null}}]),t}(),x="Error: An error occurred compiling the shaders: ";function m(t){var e=t.split("\n"),n=(e.length+1).toString().length;return e=e.map((function(t,e){return"".concat((e+1).toString().padStart(n),"|  ").concat(t)}))}function S(t,e,n){try{var a,r=function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=m(t),r=(a.length+1).toString().length,i=e.toString(),o=[],s=[];i.startsWith(x)&&(i=i.substr(x.length));for(var l,u,c=i.split("\n"),h=function(t){for(var e=0,n=0,a=0;a<t.length;a+=1)/ERROR/.exec(t[a])&&(e+=1),/WARNING/.exec(t[a])&&(n+=1);return{errCount:e,warnCount:n}}(c),f=0,d=0;d<c.length;d+=1){var p=c[d],v=/0:(\d+)/.exec(p);if(v){var y=+v[1]+f,g="".concat(" ".repeat(r),"|").concat((l=a[y-1],u=void 0,u=/\d+\|(\s+)/.exec(l)," ".repeat(u?u[1].length:2)));o.push("".concat(p,"\n").concat(a[y-2],"\n").concat(a[y-1],"\n").concat(g,"^\n").concat(a[y]));var S=n?"%c":"";a.splice(y,0,"".concat(S).concat(g,"^--").concat(p).concat(S)),n&&(s.push("color: red;"),s.push("color: inherit;")),f+=1}}return{fullText:a.join("\n"),firstError:o[0],errorsStats:h,fullTextStyle:s}}(t,n),i=r.errorsStats;console.group("Error: An error occurred compiling the shader ".concat(e,": ").concat(i.errCount," ERRORS, ").concat(i.warnCount," WARNINGS")),console.log(r.firstError),console.groupCollapsed("Show more"),(a=console).log.apply(a,[r.fullText].concat(d(r.fullTextStyle))),console.groupEnd(),console.groupEnd()}catch(t){console.warn("Unable to process GLSG compiling error.")}}var k=["pickCurrentValue","pickValue","float"],b=function(t,e){if(!t)throw new Error(e)},T=function(t,e){if(t.shape.length!==e.shape.length)return!1;for(var n=0;n<t.shape.length;n+=1)if(t.shape[n]!==e.shape[n])return!1;return!0},_=function(t,e){b(t,'GammaCV: DOMFeature not supported, "'.concat(e,'" is not supported in current environment'))},E=function(t){_(document&&document.createElement,t)},w=function(){_(document&&document.querySelector,"document.querySelector")},C=function(){b("function"==typeof OffscreenCanvas,"OffscreenCanvas")},I=function(t){return Array.isArray(t)&&t.length>0&&!t.some((function(t){return t%1!=0}))},A=function(t){return t instanceof Z},V=function(t){return t instanceof ot},M=function(t){return t instanceof it},R=function(t){return"function"==typeof HTMLVideoElement&&t instanceof HTMLVideoElement},L=function(t){return"function"==typeof HTMLCanvasElement?t instanceof HTMLCanvasElement:"getContext"in t},O=function(t){return k.includes(t)},U=function(t){return/^[A-Za-z](\w+)?$/.test(t)},K=function(t){return t[0]>0&&t[1]>0},P=function(t){i(a,t);var e=f(a);function a(){return n(this,a),e.apply(this,arguments)}return r(a)}(c(Error));function F(t,e){console.warn('GammaCV Deprecation Warning: "'.concat(t,'" is deprecated').concat(e?", ".concat(e):"",'. "').concat(t,'" will be removed in next major version.'))}function D(){try{return E("canvas"),document.createElement("canvas")}catch(t){return C(),new OffscreenCanvas(1,1)}}function G(){return E("img"),document.createElement("img")}function H(){return E("video"),document.createElement("video")}var W={};var X={SUPPORTS_FLOAT_TEXTURES:function(){var t,e=!1;try{var n=D().getContext("webgl");if(!n)return!1;if(!n.getExtension("OES_texture_float"))return!1;var a=n.createFramebuffer(),r=n.createTexture();W.MAX_TEXTURE_SIZE=n.getParameter(n.MAX_TEXTURE_SIZE),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,n.FLOAT,null),n.bindFramebuffer(n.FRAMEBUFFER,a),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r,0),e=n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE,n.readPixels(0,0,1,1,n.RGBA,n.FLOAT,new Float32Array(4)),t=n.getError()===n.NO_ERROR}catch(e){t=!1}return e&&t}(),DEBUG:!1,MAX_TEXTURE_SIZE:W.MAX_TEXTURE_SIZE},B=Object.assign({},X);function N(t){var e="\nvoid main(void) {\n  vec2 coords = gl_FragCoord.xy - 0.5;\n  vec4 result = operation(coords.y, coords.x);\n\n  gl_FragColor = result;\n}\n  ";return B.SUPPORTS_FLOAT_TEXTURES||"float32"!==t.dtype||(e="\n    void main(void) {\n      vec2 coords = gl_FragCoord.xy;\n\n      highp float ox = floor(coords.x / 4.0);\n      float dx = floor(coords.x - ox * 4.0 + 0.5);\n    \n      vec4 result = operation(coords.y - 0.5, floor((coords.x - 0.5) / 4.0));\n\n      float value;\n\n      if (dx == 1.0) {\n        value = result.r;\n      } else if (dx == 2.0) {\n        value = result.g;\n      } else if (dx == 3.0) {\n        value = result.b;\n      } else if (dx == 4.0) {\n        value = result.a;\n      }\n    \n      gl_FragColor = encode_float(value);\n    }\n    "),e}var z=Object.freeze({__proto__:null,float:function(){return"precision highp float;highp vec4 encode_float(highp float f){if(f==1./0.){return vec4(0.0,0.0,128.0,127.0)/255.0;}highp vec4 rgba;highp float e=5.0;highp float F=abs(f);highp float sign=step(0.0,-f);highp float exponent=floor(log2(F));highp float mantissa=(exp2(-exponent)*F);exponent=floor(log2(F)+127.0)+floor(log2(mantissa));rgba[0]=128.0*sign+floor(exponent*exp2(-1.0));rgba[1]=128.0*mod(exponent,2.0)+mod(floor(mantissa*64.0*2.0),128.0);rgba[2]=floor(mod(floor(mantissa*exp2(23.0-8.0)),exp2(8.0)));rgba[3]=floor(exp2(23.0)*mod(mantissa,exp2(-15.0)));return rgba.abgr/255.0;}float decode_float(highp vec4 rgba){rgba=rgba.abgr*255.0;highp float sign=1.0-step(128.0,rgba[0])*2.0;highp float exponent=2.0*mod(rgba[0],128.0)+step(128.0,rgba[1])-127.0;exponent=floor(exponent+0.5);highp float mantissa=mod(rgba[1],128.0)*32768.0*2.0+rgba[2]*256.0+rgba[3]+float(0x800000);highp float result=sign*mantissa*exp2(-23.0)*exp2(exponent);return result;}"},main:N,pickValue:function(t){for(var e=Object.keys(t.input),n=[],a=function(){var a=e[r];if(!t.input[a].shape)return"continue";var i=d(t.input[a].shape),o=i[1].toFixed(1),s=i[0].toFixed(1),l=(4*i[1]).toFixed(1),u=function(t,e,n){return"".concat(t," ").concat(e,"_").concat(a,"(float y, float x) {\n\treturn texture2D(").concat(a,", vec2((x + 0.5) / ").concat(o,", (y + 0.5) / ").concat(s,"))").concat(n,";\n}")};B.SUPPORTS_FLOAT_TEXTURES||"float32"!==t.input[a].dtype||(u=function(t,e,n){return"\n        ".concat(t," ").concat(e,"_").concat(a,"(float y, float x) {\n          float r = decode_float(texture2D(").concat(a,", vec2((x * 4.0 + 0.5) / ").concat(l,", y / ").concat(s,")));\n          float g = decode_float(texture2D(").concat(a,", vec2((x * 4.0 + 1.5) / ").concat(l,", y / ").concat(s,")));\n          float b = decode_float(texture2D(").concat(a,", vec2((x * 4.0 + 2.5) / ").concat(l,", y / ").concat(s,")));\n          float a = decode_float(texture2D(").concat(a,", vec2((x * 4.0 + 3.5) / ").concat(l,", y / ").concat(s,")));\n\n          return vec4(r, g, b, a)").concat(n,";\n        }\n      ")}),n.push(u("vec4","pickValue","")),n.push(u("float","pickScalarValue",".x"))},r=0;r<e.length;r+=1)a();return n.join("\n")}});function j(t){return["bool","int","uint","float","double","vec2","vec3","vec4","mat2","mat3","mat4","sampler2D"].indexOf(t)>=0}function Y(t){var n=e(t);t=String(t);var a=/^(vec\d|mat\d)\([^)]+\)$/.exec(t);return a?n=a[1]:/^\d+$/.exec(t)?n="int":/^\d+\.(\d+)?$/.exec(t)?n="float":"boolean"===n&&(n="bool"),n}function q(t){var n,a;if(a=t.kernel,/void main\(([^)]+)?\)([\s]+)?{/.exec(a))n=t.kernel;else{var r=function(t){for(var n=Object.assign({},t.uniform),a=Object.keys(t.input),r="precision highp float;\n",i=0;i<a.length;i+=1)n[a[i]]={dtype:"sampler2D"};for(var o=Object.keys(n),s=0;s<o.length;s+=1){var l=o[s];if(!j(n[l].dtype))throw new Error("KernelConstructor: Uniform ".concat(l,' has invalid type "').concat(n[l].dtype,'"'));r+="uniform ".concat(n[l].dtype," ").concat(l,";\n")}r+="varying vec2 texCoords;\n";for(var u=Object.keys(t.constant),c=0;c<u.length;c+=1){var h=u[c],f=t.constant[h];"number"===e(f)&&f%1==0&&(f=f.toFixed(1));var d=Y(f);if(!j(d))throw new Error("KernelConstructor: Constant ".concat(h,', has invalid type "').concat(d,'"'));r+="#define ".concat(h," ").concat(f,"\n")}return r}(t),i=function(t){var e=[];return B.SUPPORTS_FLOAT_TEXTURES||e.push("float"),e.concat(t.chunks.filter((function(t,e,n){return n.indexOf(t)===e}))).map((function(e){var n=" Chunk ".concat(e," "),a=35-n.length,r="".concat("-".repeat(Math.floor(a/2))).concat(n).concat("-".repeat(Math.ceil(a/2)));if("function"==typeof z[e])return"/*".concat(r,"*/\n").concat(z[e](t),"\n/*").concat("-".repeat(35),"*/");throw new TypeError('KernelConstructor: Chunk "'.concat(e,'" is not a function'))})).join("\n")}(t),o=N(t);n=[r,i,t.kernel,o].join("\n\n")}return B.DEBUG&&(console.groupCollapsed(t.name),console.log(m(n).join("\n")),console.groupEnd()),n}var Z=function(t){i(a,t);var e=f(a);function a(t){var r;return n(this,a),b(void 0!==t,"Operation: Operation should have a name"),(r=e.call(this,t)).dtype=null,r.input={},r.uniform={},r.constant={},r.chunks=[],r.inputKeys=[],r.isInitialized=!1,r.lastCtx=Math.random(),r.cache=!0,r}return r(a,[{key:"run",value:function(t,e,n){b(this.isInitialized,"Operation: Unable to run uninitialized operation.");var a=this.gl,r=t.texture[this.name];if(e===this.lastCtx&&this.cache&&!n)return r.bind(this.program,!1,this.inputKeys.length),this.bindBuffer(),!1;this.lastCtx=e,a.useProgram(this.program);for(var i=0;i<this.inputKeys.length;i+=1){var o=this.inputKeys[i],s=this.input[o],l=s.name,u=t.texture[l];u.bind(this.program,o,i),M(s)&&u.set(s),V(s)&&u.set(s.media)}return r.bind(this.program,!1,this.inputKeys.length),this.bindBuffer(),B.SUPPORTS_FLOAT_TEXTURES?a.viewport(0,0,this.shape[1],this.shape[0]):a.viewport(0,0,("float32"===this.dtype?4:1)*this.shape[1],this.shape[0]),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0),!0}},{key:"unbindBuffer",value:function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null)}},{key:"bindBuffer",value:function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer)}},{key:"init",value:function(t){if(!this.isInitialized){if(this.gl=t,this.program=t.createProgram(),this.framebuffer=t.createFramebuffer(),this.isInitialized)return!1;this.constant.OUT_VIEW="vec2(".concat(this.shape[1],", ").concat(this.shape[0],")"),this.kernel=q(this);try{this.vertexShader=this.getShader("vertex","precision highp float;attribute vec3 aVertexPosition;attribute vec2 aTextureCoords;varying vec2 texCoords;void main(void){texCoords=aTextureCoords;gl_Position=vec4(aVertexPosition,1.0);}"),t.attachShader(this.program,this.vertexShader),this.fragmentShader=this.getShader("fragment",this.kernel),t.attachShader(this.program,this.fragmentShader),t.linkProgram(this.program),t.useProgram(this.program)}catch(t){throw S(this.kernel,this.name,t),new Error("Operation: Error during shader compilation.\n".concat(t.message))}this.attributes={aVertexPosition:new g(this.gl,this.program,"aVertexPosition","vec3"),aTextureCoords:new g(this.gl,this.program,"aTextureCoords","vec2"),aIndices:new g(this.gl,this.program,"aIndices","int")},this.attributes.aVertexPosition.set([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),this.attributes.aTextureCoords.set([1,1,0,1,0,0,1,0]),this.attributes.aIndices.set([0,1,2,0,2,3]);for(var e=Object.keys(this.uniform),n=0;n<e.length;n+=1){var a=this.uniform[e[n]];this.uniform[e[n]]=new y(this.gl,this.program,a.name,a.dtype),a.defaultValue&&this.uniform[e[n]].set(a.defaultValue)}this.isInitialized=!0}return!0}},{key:"getShader",value:function(t,e){var n=this.gl,a=null;if(a="fragment"===t?n.createShader(n.FRAGMENT_SHADER):n.createShader(n.VERTEX_SHADER),n.shaderSource(a,e),n.compileShader(a),!n.getShaderParameter(a,n.COMPILE_STATUS))throw new Error("Operation: An error occurred compiling the shaders.\n".concat(n.getShaderInfoLog(a)));return a}},{key:"traverse",value:function(t,e){for(var n=Object.keys(this.input),a=0;a<n.length;a+=1){var r=n[a];A(this.input[r])?this.input[r].traverse(t,e):t(this.input[r],e)}t(this,e)}},{key:"getDependencies",value:function(){for(var t=[],e=Object.keys(this.input),n=0;n<e.length;n+=1){var a=e[n];if(A(this.input[a])){for(var r=this.input[a].getDependencies(),i=0;i<r.length;i+=1)-1===t.indexOf(r[i])&&t.push(r[i]);t.concat(r)}}return t.push(this.name),t}},{key:"assignInput",value:function(t,e){this.input[t]=e,-1===this.inputKeys.indexOf(t)&&this.inputKeys.push(t)}},{key:"cloneProp",value:function(t){for(var e=Object.keys(this[t]),n={},a=0;a<e.length;a+=1){var r=e[a];n[r]=this[t][r]}return n}},{key:"destroy",value:function(){this.program&&this.gl.deleteProgram(this.program),this.vertexShader&&this.gl.deleteShader(this.vertexShader),this.fragmentShader&&this.gl.deleteShader(this.fragmentShader),this.framebuffer&&this.gl.deleteFramebuffer(this.framebuffer)}},{key:"clone",value:function(){var t=new a(this.name.split(":")[0]);return t.input=this.cloneProp("input"),t.uniform=this.cloneProp("uniform"),t.constant=this.cloneProp("constant"),t.dtype=this.dtype,t.kernel=this.kernel,t.chunks=this.chunks,t}}]),a}(v),$=function(){function t(e,a,r,i){if(n(this,t),"float32"!==e&&"uint8"!==e)throw new Error("GPUTexture: Invalid texture type, currently supported is: float32, uint8, but got ".concat(e," "));this.unit=r,this.dtype=e,this.gl=a,this.ctx=a.createTexture(),this.shape=i,a.bindTexture(a.TEXTURE_2D,this.ctx),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),this.allocate()}return r(t,[{key:"allocate",value:function(){var t=this.gl,e=this.shape[1],n=t.UNSIGNED_BYTE;"float32"===this.dtype&&(B.SUPPORTS_FLOAT_TEXTURES?n=t.FLOAT:e*=4),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,this.shape[0],0,t.RGBA,n,null)}},{key:"set",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=this.gl;if(R(t)||L(t))e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);else{var n=t.shape[1],a=e.UNSIGNED_BYTE,r=t.data;"float32"===t.dtype&&(B.SUPPORTS_FLOAT_TEXTURES?a=e.FLOAT:(n*=4,r=t.uint8View)),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n,this.shape[0],0,e.RGBA,a,r)}}},{key:"bind",value:function(t,e,n){var a=this.gl;if(e){var r=a.getUniformLocation(t,e);a.uniform1i(r,n)}a.activeTexture(a.TEXTURE0+n),a.bindTexture(a.TEXTURE_2D,this.ctx),this.unit=n}},{key:"unbind",value:function(){var t=this.gl;t.activeTexture(t.TEXTURE0+this.unit),t.bindTexture(t.TEXTURE_2D,null)}},{key:"delete",value:function(){var t=this.gl;t.deleteTexture(this.ctx),this.gl=null,this.program=null,this.ctx=null,t.bindTexture(t.TEXTURE_2D,null)}}]),t}(),J=function(){function t(){n(this,t),this.canvas=D(),this.canvas.width=1,this.canvas.height=1,this.initWebGL(this.canvas),this.operation={},this.texture={},this.textureCount=0}return r(t,[{key:"initWebGL",value:function(t,e){this.canvas=t;var n=this.canvas.getContext("webgl",e);b(!!n,"Session: WebGL not supported.");var a=n.getExtension("OES_texture_float");b(!!a,"Session: Unable to find extension OES_texture_float"),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),this.gl=n}},{key:"init",value:function(t){b(!!t,"Session: Unable to initialize undefined operation"),b(A(t)||M(t),"Session: Unable to initialize operation with invalid input type"),A(t)&&t.traverse((function(t,e){e.operation[t.name]=t}),this),(M(t)||V(t))&&(this.operation[t.name]=t),this.update()}},{key:"update",value:function(){for(var t=this.gl,e=Object.keys(this.operation),n=0;n<e.length;n+=1){var a=this.operation[e[n]];a instanceof Z&&a.init(this.gl),this.texture[e[n]]||(this.texture[e[n]]=new $(a.dtype,this.gl,this.textureCount,a.shape),a instanceof Z&&(t.bindFramebuffer(t.FRAMEBUFFER,a.framebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture[e[n]].ctx,0),t.bindFramebuffer(t.FRAMEBUFFER,null)),this.textureCount+=1)}}},{key:"runOp",value:function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=t.sequence,r=!1,i=0;i<a.length;i+=1){var o=a[i],s=this.operation[o],l=i===a.length-1;b(!!s,"Session: Unable to run uninitialized operation ".concat(t.name,".")),L(n)&&l&&(this.canvas.width===s.shape[1]&&this.canvas.height===s.shape[0]||(this.canvas.width=s.shape[1],this.canvas.height=s.shape[0]),s.framebuffer=null),r=!!s.run(this,e,r),n&&l&&M(n)&&this.readToTensor(n),n&&l&&L(n)&&this.readToCanvas(n,s.shape)}}},{key:"destroy",value:function(){var t=this.gl.getExtension("WEBGL_lose_context"),e=Object.keys(this.texture),n=Object.keys(this.operation);t&&t.loseContext();for(var a=0;a<e.length;a+=1)this.texture[e[a]].delete();for(var r=0;r<n.length;r+=1){var i=this.operation[n[r]];i instanceof Z&&i.destroy()}this.canvas=null,this.operation={},this.texture={},this.gl=null,this.textureCount=0}},{key:"readToTensor",value:function(t){var e=this.gl,n=t.shape[0],a=t.shape[1],r=e.UNSIGNED_BYTE,i=t.data;"float32"===t.dtype&&(B.SUPPORTS_FLOAT_TEXTURES?r=e.FLOAT:(a*=4,i=t.uint8View)),e.readPixels(0,0,a,n,e.RGBA,r,i)}},{key:"readToCanvas",value:function(t,e){var n=t.getContext("2d");t.width=e[1],t.height=e[0],n.drawImage(this.canvas,0,0,e[1],e[0],0,0,e[1],e[0])}}]),t}(),Q=function(){function t(e){n(this,t),this.op=new Z(e),this.name=e,this.checkShape=function(t){return t[Object.keys(t)[0]]},this.preCompile=function(){},this.postCompile=function(){},this.chunks=[]}return r(t,[{key:"GLSLKernel",value:function(t){return b("string"==typeof t,"RegisterOperation: The kernel should be a string but it is not."),this.op.kernel=t,this}},{key:"LoadChunk",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var a=0,r=e;a<r.length;a++){var i=r[a];b(O(i),"RegisterOperation: There is no available GLSL chunk supported: ".concat(i))}return this.op.chunks=this.op.chunks.concat(e),this}},{key:"Input",value:function(t,e){return b(U(t)),this.op.input[t]={name:t,dtype:e},this}},{key:"Output",value:function(t){return b(null===this.op.dtype,"RegisterOperation: The operation allows a single output."),this.op.dtype=t,this}},{key:"Constant",value:function(t,e){return b(U(t)),this.op.constant[t]=e,this}},{key:"SetShapeFn",value:function(t){return b("function"==typeof t,"RegisterOperation: SetShapeFn should receive function in first argument"),this.checkShape=t,this}},{key:"PreCompile",value:function(t){return b("function"==typeof t,"RegisterOperation: PreCompile should receive function in first argument"),this.preCompile=t,this}},{key:"PostCompile",value:function(t){return b("function"==typeof t,"RegisterOperation: PostCompile should receive function in first argument"),this.postCompile=t,this}},{key:"Uniform",value:function(t,e,n){return b(U(t)),this.op.uniform[t]={name:t,dtype:e,defaultValue:n},this}},{key:"Compile",value:function(t){var e=this.op.clone(),n={},a=Object.keys(t);this.preCompile(e);for(var r=0;r<a.length;r+=1){var i=a[r],o=t[i];b(!!o,"RegisterOperation:".concat(e.name,".").concat(i,":\n         Can't compile operation with undefined input.")),b(M(o)||V(o)||A(o),"RegisterOperation:".concat(e.name,".").concat(i,":\n         Can't compile operation with invalid input type.\n         You can only use Tensor or another Operation to be an input")),n[i]=t[i].shape,e.assignInput(i,t[i])}return e.shape=this.checkShape(n),e.sequence=e.getDependencies(),e}}]),t}();function tt(t){for(var e=new Array(t),n=0;n<t;n+=1)e[n]=n;return e}function et(t,e){if(e.data.set)e.data.set(t.data);else for(var n=0;n<e.size;n+=1)e.data[n]=t.data[n]}function nt(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Array(t.shape.length).fill(!0),a=t.shape;if(t===e&&(t=t.clone()),t.shape.length!==e.shape.length)throw new Error("invertTensor: Unable to invert, input and output has different shapes");for(var r=new Array(a.length),i=new Function("coords","tmpArr","shape","".concat(n.map((function(t,e){return t?"tmpArr[".concat(e,"] = shape[").concat(e,"] - 1 - coords[").concat(e,"]"):"tmpArr[".concat(e,"] = coords[").concat(e,"]")})).join(";"),"; return tmpArr;")),o=0;o<t.size;o+=1){var s,l=it.IndexToCoord(a,o),u=i(l,r,a);e.set.apply(e,d(u).concat([(s=t).get.apply(s,d(l))]))}return e}function at(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,a=0;a<t.size;a+=1)n.data[a]=e(t.data[a],a)}function rt(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[1,t.length,4],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"float32",a=arguments.length>3?arguments[3]:void 0,r=new Array(4*t.length),i=0;i<r.length;i+=1)r[i]=(i+1)%4==0&&"number"==typeof a?a:t[~~(i/4)];return new it(n,e,it.GetTypedArray(n,r))}var it=function(t){i(a,t);var e=f(a);function a(t,r,i,o){var s,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return n(this,a),(s=e.call(this,"Tensor")).dtype=t,s.shape=r||[i.length],b(I(s.shape),"Tensor: Shape is not valid"),o&&(b(I(o),"Tensor: Stride is not valid"),b(s.shape.length===o.length,"Tensor: Stride length should be equal to shape length")),b("number"==typeof l&&l%1==0,"Tensor: Offset should be integer, but got ".concat(l)),s.size=a.GetSize(s.shape),s.stride=o||s._defineStride(s.shape),s.offset=l,s._compileJITMethods(),void 0===i?(s.data=a.Malloc(t,s.size),s.empty=a.Malloc(t,s.size)):s.assign(i),B.SUPPORTS_FLOAT_TEXTURES||"float32"!==t||(s.uint8View=new Uint8Array(s.data.buffer)),s}return r(a,[{key:"_compileJITMethods",value:function(){var t=this,e=tt(this.shape.length),n=e.map((function(t){return"i".concat(t)})).join(","),a="".concat(this.offset,"+").concat(e.map((function(e){return"".concat(t.stride[e],"*i").concat(e)})).join("+"));this.get=new Function("return function get(".concat(n,") { return this.data[").concat(a,"]; }"))(),this.set=new Function("return function get(".concat(n,", v) { this.data[").concat(a,"] = v; }"))(),this.index=new Function("return function get(".concat(n,", v) { return ").concat(a,"; }"))()}},{key:"_defineStride",value:function(t){for(var e=t.length,n=new Array(e),a=e-1,r=1;a>=0;a-=1)n[a]=r,r*=this.shape[a];return n}},{key:"assign",value:function(t){var e=a.DefineType(t),n=t.length;return b(e===this.dtype,"Tensor: Different dtypes assigned: \n   expected - ".concat(this.dtype," \n   actual - ").concat(e)),b(n===this.size+this.offset,"Tensor: Different sizes assigned: \n   expected - ".concat(this.size+this.offset," \n   actual - ").concat(n)),this.data=t,this}},{key:"release",value:function(){return this.empty?this.data.set(this.empty):this.data=a.Malloc(this.dtype,this.size),this}},{key:"relese",value:function(){return F("Tensor: relese"),this.release(),this}},{key:"clone",value:function(){var t=new a(this.dtype,this.shape,void 0,this.stride,this.offset);return et(this,t),t}}],[{key:"IndexToCoord",value:function(t,e){for(var n=new Array(t.length),a=e,r=t.reduce((function(t,e){return t*e})),i=0;i<=t.length-2;i+=1){var o=~~(a/(r/=t[i]));a%=r,n[i]=o}return n[n.length-1]=a%t[t.length-1],n}},{key:"CoordToIndex",value:function(t,e){for(var n=1,a=0,r=t.length-1;r>=0;r-=1)a+=n*e[r],n*=t[r];return a}},{key:"Malloc",value:function(t,e){switch(t){case"uint8":return new Uint8Array(e);case"uint16":return new Uint16Array(e);case"uint32":return new Uint32Array(e);case"int8":return new Int8Array(e);case"int16":return new Int16Array(e);case"int32":return new Int32Array(e);case"float32":return new Float32Array(e);case"float64":return new Float64Array(e);case"uint8c":return new Uint8ClampedArray(e);case"array":return new Array(e);default:throw new Error("Tensor: Unexpected type: ".concat(t,"."))}}},{key:"DefineType",value:function(t){var e=Object.prototype.toString.call(t);switch(e){case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Float32Array]":return"float32";case"[object Float64Array]":return"float64";case"[object Uint8ClampedArray]":return"uint8c";case"[object Array]":return"array";default:throw new Error("Tensor: Unknown dtype: ".concat(e,"."))}}},{key:"GetTypedArray",value:function(t,e){if(t===a.DefineType(e))return e;switch(t){case"uint8":return new Uint8Array(e);case"uint16":return new Uint16Array(e);case"uint32":return new Uint32Array(e);case"int8":return new Int8Array(e);case"int16":return new Int16Array(e);case"int32":return new Int32Array(e);case"float32":return new Float32Array(e);case"float64":return new Float64Array(e);case"uint8c":return new Uint8ClampedArray(e);case"array":return new Array(e);default:throw new Error("Unknown type: ".concat(t,"."))}}},{key:"GetSize",value:function(t){return t.reduce((function(t,e){return t*e}),1)}}]),a}(v),ot=function(t){i(a,t);var e=f(a);function a(t,r){var i;return n(this,a),(i=e.call(this,"MediaInput")).dtype="uint8",i.inputKeys=[],i.isInitialized=!1,i.lastCtx=Math.random(),i.cache=!0,i.assignMedia(t,r),i}return r(a,[{key:"assignMedia",value:function(t,e){t&&b(R(t)||L(t),"MediaInput: Is only Video, Canvas element available as input"),e&&b(I(e),"MediaInput: Shape is invalid"),this.media=t,this.shape=e}}]),a}(v);function st(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=new ImageData(t.shape[1],t.shape[0]),r=t.shape[0]*t.shape[1];if(e&&"uint8"===t.dtype)return a.data.set(t.data),a;if(!e){for(var i=0;i<r;i+=1){var o=~~(i/t.shape[0]),s=i-o*t.shape[1],l=t.data[i],u=0;u=n?4*(s*t.shape[0]+o):4*(o*t.shape[1]+s),a.data[u+0]=l,a.data[u+1]=l,a.data[u+2]=l,a.data[u+3]=255}return a}if("float32"===t.dtype)for(var c=0;c<t.size;c+=1)a.data[c]=255*t.data[c];else for(var h=0;h<t.size;h+=1)a.data[h]=t.data[h];return a}function lt(t,e){return t*e}function ut(t,e){return e/t}function ct(t,e,n){if(e){var a=ut(t,e);if(a>n)return{width:e,height:a}}return{width:lt(t,n),height:n}}var ht=function(){function t(e,a){n(this,t),this.video=H(),this.video.muted=!0,this.video.playsInline=!0,this.canvas=D(),this.canvasCtx=this.canvas.getContext("2d"),this.sourceCanvas=D(),this.sourceCanvasCtx=this.sourceCanvas.getContext("2d"),this.width=e,this.height=a,this.sourceWidth=e,this.sourceHeight=a,this.setSize(e,a),this.track=null}return r(t,[{key:"setSize",value:function(t,e){this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this.sourceCanvas.width=t,this.sourceCanvas.height=e,this.sourceMinWidth=t,this.sourceMinHeight=e}},{key:"setSourceSize",value:function(t,e){var n=ct(t/e,this.width,this.height),a=function(t,e,n){if(e){var a=ut(t,e);if(a<=n)return{width:e,height:a}}return{width:lt(t,n),height:n}}(this.width/this.height,t,e),r=ct(t/e,a.width,a.height);this.sourceMinWidth=n.width,this.sourceMinHeight=n.height,this.sourceWidth=r.width,this.sourceHeight=r.height,this.sourceCanvas.width=a.width,this.sourceCanvas.height=a.height}},{key:"getDevice",value:function(){return this.track?this.track.getSettings().deviceId:null}},{key:"start",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.started=!0;var a={video:{width:{min:240,ideal:1080,max:1920},height:{min:240,ideal:1080,max:1920},aspectRatio:{exact:this.width/this.height},deviceId:t?{ideal:t}:void 0,facingMode:n?{exact:n}:null}},r=navigator.userAgent,i=!(-90===window.orientation||90===window.orientation||window.offsetWidth>window.offsetHeight);/android/i.test(r)&&i&&(a.video.aspectRatio.exact=1/a.video.aspectRatio.exact),-1!==r.indexOf("Safari")&&-1===r.indexOf("Chrome")&&(delete a.video.width,delete a.video.height,delete a.video.aspectRatio),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia;var o=Promise.resolve();return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?o=o.then((function(){return navigator.mediaDevices.getUserMedia(a)})):navigator.getUserMedia&&(o=o.then((function(){return new Promise((function(t){return navigator.getUserMedia(a,t)}))}))),o.then((function(t){if(t){var n=t.getTracks();return e.started?("srcObject"in e.video?e.video.srcObject=t:e.video.src=window.URL.createObjectURL(t),e.track=n[0],e.video.play().then((function(){return e.setSourceSize(e.video.videoWidth,e.video.videoHeight)}))):(n.forEach((function(t){return t.stop()})),null)}throw new Error("getUserMedia not found or no stream was created")}))}},{key:"stop",value:function(){this.started=!1,this.track&&(this.track.stop(),this.track=null)}},{key:"drawImage",value:function(t,e,n,a,r){t.drawImage(this.video,(a-e)/-2,(r-n)/-2,a,r)}},{key:"getImageBuffer",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.canvasCtx,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.width,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.height,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:n,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:a,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:this.sourceMinWidth,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:this.sourceMinHeight;this.drawImage(e,o,s,l,u);var c=e.getImageData(r,i,o,s);if(t instanceof it)return t.data.set(c.data),t;switch(t){case"uint8":return new Uint8Array(c.data);case"uint8c":return c.data;case"float32":return new Float32Array(c.data);default:return c}}},{key:"getImageBufferTo",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.canvasCtx,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.width,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.height,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:n,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:a,l=arguments.length>8?arguments[8]:void 0;e.drawImage(this.video,(this.sourceWidth-this.width)/-2,(this.sourceHeight-this.height)/-2,this.sourceWidth,this.sourceHeight);var u=e.getImageData(r,i,o,s);l.data=u.data.buffer}},{key:"getSourceImageBuffer",value:function(t,e,n,a,r){return this.getImageBuffer(t,this.sourceCanvasCtx,this.sourceCanvas.width,this.sourceCanvas.height,e,n,a,r,this.sourceWidth,this.sourceHeight)}}],[{key:"IsAvailable",value:function(){var t={video:{width:{min:480,ideal:1080,max:1920},height:{min:480,ideal:1080,max:1920}}};navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia;var e=navigator.userAgent;-1!==e.indexOf("Safari")&&-1===e.indexOf("Chrome")&&(delete t.video.width,delete t.video.height);var n=Promise.resolve();return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?n=n.then((function(){return navigator.mediaDevices.getUserMedia(t)})):navigator.getUserMedia&&(n=n.then((function(){return new Promise((function(e){return navigator.getUserMedia(t,e)}))}))),n.then((function(t){var e=t.getTracks(),n=e[0].getSettings().deviceId;return e.forEach((function(t){return t.stop()})),n||!0})).catch((function(){return Promise.resolve(!1)}))}},{key:"getDevices",value:function(){return"mediaDevices"in navigator&&"enumerateDevices"in navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then((function(t){return t.filter((function(t){return"videoinput"===t.kind}))})):Promise.resolve(null)}}]),t}();function ft(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=new it("float32",[t,t]),a=(t-1)/2,r=new it("float32",[t,t,4]),i=0,o=0;o<t;o+=1)for(var s=0;s<t;s+=1){var l=Math.exp(-.5*(Math.pow((s-a)/e,2)+Math.pow((o-a)/e,2)))/(2*Math.PI*e*e);n.set(s,o,l),i+=n.get(s,o)}for(var u=0;u<t;u+=1)for(var c=0;c<t;c+=1)r.set(c,u,0,n.get(c,u)/i),r.set(c,u,1,n.get(c,u)/i),r.set(c,u,2,n.get(c,u)/i);return r}var dt=Object.freeze({__proto__:null,boxBlur:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=new it("float32",[t,t,4]),n=Math.pow(t,2),a=0;a<e.data.length;a+=1)e.data[a]=1/n;return e},edgeDetection:function(){return rt([1,0,-1,0,0,0,-1,0,1],[3,3,4],"float32")},edgeDetection2:function(){return rt([0,1,0,1,-4,1,0,1,0],[3,3,4],"float32")},edgeDetection3:function(){return rt([-1,-1,-1,-1,8,-1,-1,-1,-1],[3,3,4],"float32")},gaussianBlur:ft,invert:function(){return rt([0,0,0,0,-1,0,0,0,0],[3,3,4],"float32")},sharpen:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=-1*t;return rt([0,e,0,e,1+4*t,e,0,e,0],[3,3,4],"float32")},unsharpMasking:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=ft(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:1),a=~~((t-1)/2),r=1+1*e-n.get(a,a,0),i=1+1*e-n.get(a,a,1),o=1+1*e-n.get(a,a,2),s=0;s<n.size;s+=1)n.data[s]=-n.data[s];return n.set(a,a,0,r),n.set(a,a,1,i),n.set(a,a,2,o),n}}),pt=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new Q("Convolution2d").Input("tSrc",t.dtype).Input("tKernel","float32").Output(t.dtype).LoadChunk("pickValue").Constant("KERNEL_WIDTH",e.shape[1]).Constant("KERNEL_HEIGHT",e.shape[0]).Uniform("bias","float",a).Uniform("factor","float",n).GLSLKernel("const float hWidth=(KERNEL_WIDTH-1.0)/2.0;const float hHeight=(KERNEL_HEIGHT-1.0)/2.0;vec4 operation(float y,float x){vec3 finalColour=vec3(0.0);for(float dy=-hHeight;dy<=hHeight;dy+=1.0){for(float dx=-hWidth;dx<=hWidth;dx+=1.0){vec3 k=pickValue_tKernel(float(dy+hHeight),float(dx+hWidth)).rgb;finalColour+=pickValue_tSrc(y+dy,x+dx).rgb*k;}}return vec4(finalColour*factor+bias,1.0);}").Compile({tSrc:t,tKernel:e})},vt=dt,yt=function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"nearest";b("nearest"===a||"bicubic"===a||"mean"===a||"max"===a,'ResizeOperation: Unsupported type of operation. Currently supported only "nearest" and "bicubic"'),"mean"===a&&(F('ResizeOperation: type "mean"','use "bicubic" instead'),a="bicubic"),"max"===a&&(F('ResizeOperation: type "max"','use "nearest" instead'),a="nearest"),b(e>0||n>0,"ResizeOperation: Size of image should be greater than 0");var r=0;return"nearest"===a?r=0:"bicubic"===a&&(r=1),new Q("Resize").Input("tSrc",t.dtype).Output(t.dtype).Constant("TX",t.shape[1]/e).Constant("TY",t.shape[0]/n).Constant("S",r).SetShapeFn((function(){var t=[n,e,4];return b(K(t),"ResizeOperation: Invalid operation shape"),t})).LoadChunk("pickValue").GLSLKernel("vec4 operation(float j,float i){float x=floor(i*TX);float y=floor(j*TY);if(S==0.0){return pickValue_tSrc(y,x);}if(S==1.0){float dx=floor(TX*i)-x;float dy=floor(TY*j)-y;vec4 C[4];for(float jj=0.0;jj<=3.0;jj+=1.0){vec4 d0=pickValue_tSrc(y-1.0+jj,x-1.0)-pickValue_tSrc(y-1.0+jj,x);vec4 d2=pickValue_tSrc(y-1.0+jj,x+1.0)-pickValue_tSrc(y-1.0+jj,x);vec4 d3=pickValue_tSrc(y-1.0+jj,x+2.0)-pickValue_tSrc(y-1.0+jj,x);vec4 a0=pickValue_tSrc(y-1.0+jj,x);vec4 a1=-1.0/3.0*d0+d2-1.0/6.0*d3;vec4 a2=1.0/2.0*d0+1.0/2.0*d2;vec4 a3=-1.0/6.0*d0+1.0/2.0*d2+1.0/6.0*d3;C[int(jj)]=a0+a1*dx+a2*dx*dx+a3*dx*dx*dx;}vec4 d0=C[0]-C[1];vec4 d2=C[2]-C[1];vec4 d3=C[3]-C[1];vec4 a0=C[1];vec4 a1=-1.0/3.0*d0+d2-1.0/6.0*d3;vec4 a2=1.0/2.0*d0+1.0/2.0*d2;vec4 a3=-1.0/6.0*d0-1.0/2.0*d2+1.0/6.0*d3;vec4 Cc=a0+a1*dy+a2*dy*dy+a3*dy*dy*dy;return Cc;}}").Compile({tSrc:t})},gt=function(t){return new Q("HOGDirection").Input("tSrc","uint8").Output("float32").Uniform("uWidth","float",t.shape[1]).Uniform("uHeight","float",t.shape[0]).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){float dx=pickValue_tSrc(y,x+1.0).r-pickValue_tSrc(y,x-1.0).r;float dy=pickValue_tSrc(y+1.0,x).r-pickValue_tSrc(y-1.0,x).r;float magniture=sqrt((dx*dx)+(dy*dy));return vec4(magniture,atan(dy/dx),dx,dy);}").Compile({tSrc:t})};function xt(){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[1],e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=0;n<t.length;n+=1)e/=t[n];return 1===e}function mt(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[1,1],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,1]];return xt(t[0],e.map((function(t){return t[0]})))&&xt(t[0],e.map((function(t){return t[1]})))}function St(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t,r=Math.pow(t,1/e);if(t%1!=0)throw new RangeError("Can't get parallel reduction steps for non-integer, got \"".concat(t,'"'));if(a<1)throw new RangeError("Can't get parallel reduction steps for maxLayerSize below less than 1, got \"".concat(a,'"'));if(r%1==0&&r<a)return new Array(e).fill(r);for(var i=[],o=t,s=r,l=0;l<e;l+=1){s=Math.pow(o,1/(e-l));for(var u=Math.ceil(s);(o%u!=0||o/u>a)&&o/u!=1;)u+=1;if(1===u&&n)break;o/=u,i.push(u)}return i}function kt(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[1,1],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t,r=St(t[0],e,n,a[0]),i=St(t[1],e,n,a[1]),o=[],s=0;s<e&&(r[s]||i[s]);s+=1)o.push([r[s]||1,i[s]||1]);return o}function bt(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return Math.ceil((t-e+1)/n)}var Tt=function(t,e){return new Q("ImageReduceStd").Input("tStd",t.dtype).Output(t.dtype).Constant("WIDTH",t.shape[1]).Constant("HEIGHT",t.shape[0]).Uniform("uWidth","float",t.shape[1]/e[1]).Uniform("uHeight","float",t.shape[0]/e[0]).Constant("KX",e[1]).Constant("KY",e[0]).LoadChunk("pickValue").SetShapeFn((function(){return[~~(t.shape[0]/e[0]),~~(t.shape[1]/e[1]),4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);const int w=int(WIDTH);const int h=int(HEIGHT);vec4 operation(float gly,float glx){float size=KX*KY;vec3 std=vec3(0.0,0.0,0.0);for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){vec3 mstd=pickValue_tStd(gly*KY+float(y),glx*KX+float(x)).rgb;std+=mstd*mstd;}}std/=size;std=sqrt(std);if(std.r==0.0){std.r=255.0;}if(std.g==0.0){std.g=255.0;}if(std.b==0.0){std.b=255.0;}return vec4(std,255.0);}").Compile({tStd:t})},_t=function(t,e){return new Q("ImageExtractMean").Input("tSrc",t.dtype).Output(t.dtype).Constant("WIDTH",t.shape[1]).Constant("HEIGHT",t.shape[0]).Uniform("uWidth","float",t.shape[1]/e[1]).Uniform("uHeight","float",t.shape[0]/e[0]).Constant("KX",e[1]).Constant("KY",e[0]).LoadChunk("pickValue").SetShapeFn((function(){return[~~(t.shape[0]/e[0]),~~(t.shape[1]/e[1]),4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);const int w=int(WIDTH);const int h=int(HEIGHT);vec4 operation(float gly,float glx){float size=KY*KX;float mean=0.0;float std=0.0;vec3 color=vec3(0.0,0.0,0.0);for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){vec3 value=pickValue_tSrc(gly*KY+float(y),glx*KX+float(x)).rgb;color+=value.rgb;}}color/=size;mean=color.r;for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){vec3 value=pickValue_tSrc(gly*KY+float(y),glx*KX+float(x)).rgb;std+=(value.r-mean)*(value.r-mean);}}std/=size;std=sqrt(std);if(std==0.0){std=1.0;}return vec4(color,255.0);}").Compile({tSrc:t})},Et=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2?arguments[2]:void 0,a=[[t.shape[0],t.shape[1]]];Array.isArray(e)?(b(mt(t.shape,e),"ImageMeanStd: Provided steps doesn't converge in 1 px in ImageExtractMeanStd operation"),a=e):"number"==typeof e&&e>0&&(a=kt(t.shape,e));for(var r=_t(t,a[0]),i=1;i<a.length;i+=1)r=_t(r,a[i]);if(n)return r;for(var o,s,l=function(t,e,n){return new Q("ImageExtractStd").Input("tSrc",t.dtype).Input("tMean",e.dtype).Output(t.dtype).Constant("WIDTH",t.shape[1]).Constant("HEIGHT",t.shape[0]).Uniform("uWidth","float",t.shape[1]/n[1]).Uniform("uHeight","float",t.shape[0]/n[0]).Constant("KX",n[1]).Constant("KY",n[0]).LoadChunk("pickValue").SetShapeFn((function(){return[~~(t.shape[0]/n[0]),~~(t.shape[1]/n[1]),4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);const int w=int(WIDTH);const int h=int(HEIGHT);vec4 operation(float gly,float glx){float size=KX*KY;vec3 std=vec3(0.0,0.0,0.0);vec3 mean=pickValue_tMean(0.0,0.0).rgb;for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){vec3 value=pickValue_tSrc(gly*KY+float(y),glx*KX+float(x)).rgb;std+=(value-mean)*(value-mean);}}std/=size;std=sqrt(std);if(std.r==0.0){std.r=255.0;}if(std.g==0.0){std.g=255.0;}if(std.b==0.0){std.b=255.0;}return vec4(std,255.0);}").Compile({tSrc:t,tMean:e})}(t,r,a[0]),u=1;u<a.length;u+=1)l=Tt(l,a[u]);return o=r,s=l,new Q("ImageJoin").Input("tMean",o.dtype).Input("tStd",s.dtype).Output(o.dtype).SetShapeFn((function(){return[2,1,4]})).GLSLKernel("vec4 operation(float gly,float glx){if(gly==0.0){return texture2D(tMean,vec2(0,0));}else{return texture2D(tStd,vec2(0,0));}}").Compile({tMean:o,tStd:s})},wt=function(t,e,n){return new Q("ImageReduceHistogram").Input("tSrc","float32").Output("float32").Constant("KX",e[1]).Constant("KY",e[0]).LoadChunk("pickValue").Constant("COUNT",n).SetShapeFn((function(){return[~~(t.shape[0]/e[0]),~~(t.shape[1]/e[1]),4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);vec4 operation(float gly,float iglx){float size=KX*KY;float glx=floor(iglx/COUNT);float currentIndex=iglx-(glx*COUNT);vec4 count=vec4(0.0);for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){count+=pickValue_tSrc(gly*KY+float(y),(glx*KX+float(x))*COUNT+currentIndex);}}return count;}").Compile({tSrc:t})},Ct=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/255,i=[[t.shape[0],t.shape[1]]],o=~~((a-n+r)/r);Array.isArray(e)?(b(mt(t.shape,e),"ImageExtractHistogram: Provided steps doesn't converge in 1 px in operation"),i=e):"number"==typeof e&&e>0&&(i=kt(t.shape,e,!0,[B.MAX_TEXTURE_SIZE,B.MAX_TEXTURE_SIZE/256/(B.SUPPORTS_FLOAT_TEXTURES?1:4)]));for(var s=function(t,e,n,a,r,i){return new Q("ImageExtractHistogram").Input("tSrc",t.dtype).Output("float32").Constant("KX",e[1]).Constant("KY",e[0]).LoadChunk("pickValue").Constant("MIN",n).Constant("MAX",a).Constant("STEP",r).Constant("COUNT",i).SetShapeFn((function(){return[~~(t.shape[0]/e[0]),~~(t.shape[1]/e[1])*i,4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);precision highp float;vec4 operation(float gly,float iglx){float size=KX*KY;float glx=floor(iglx/COUNT);float currentIndex=iglx-(glx*COUNT);vec4 count=vec4(0.0);vec4 ones=vec4(1.0);vec4 twos=vec4(2.0);vec4 currentIndex4=vec4(currentIndex);vec4 value;for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){value=pickValue_tSrc(gly*KY+float(y),glx*KX+float(x));vec4 index=floor((value-MIN)/STEP+0.5);count+=step(twos,ones/(abs(index-currentIndex4)));}}return count;}").Compile({tSrc:t})}(t,i[0],n,a,r,o),l=1;l<i.length;l+=1)s=wt(s,i[l],o);return s},It=function(t,e){return new Q("ImageReduceMinMax").Input("tSrc",t.dtype).Output(t.dtype).Constant("KX",e[1]).Constant("KY",e[0]).LoadChunk("pickValue").SetShapeFn((function(){return[~~(t.shape[0]/e[0]),~~(t.shape[1]/e[1]),4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);const float INF=1.0/0.0;const float h2=OUT_VIEW.y/2.0;vec4 operation(float gly,float glx){float size=KX*KY;vec3 minV=vec3(INF);vec3 maxV=vec3(-INF);vec3 value;for(int y=0;y<ky;y+=1){for(int x=0;x<kx;x+=1){value=pickValue_tSrc(gly*KY+float(y),glx*KX+float(x)).rgb;minV=min(minV,value);maxV=max(maxV,value);}}if(gly<h2){return vec4(minV,255.0);}return vec4(maxV,255.0);}").Compile({tSrc:t})},At=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=[[t.shape[0],t.shape[1]]];Array.isArray(e)?(b(mt(t.shape,e),"ImageMeanStd: Provided steps doesn't converge in 1 px in ImageExtractMeanStd operation"),n=e):"number"==typeof e&&e>0&&(n=kt(t.shape,e));for(var a=function(t,e){return new Q("ImageExtractMinMax").Input("tSrc",t.dtype).Output(t.dtype).Constant("KX",e[1]).Constant("KY",e[0]).LoadChunk("pickValue").SetShapeFn((function(){return[2*~~(t.shape[0]/e[0]),~~(t.shape[1]/e[1]),4]})).GLSLKernel("const int kx=int(KX);const int ky=int(KY);const float INF=1.0/0.0;const float h2=OUT_VIEW.y/2.0;vec4 operation(float igly,float glx){float size=KX*KY;vec3 minV=vec3(INF);vec3 maxV=vec3(-INF);float gly=igly;if(gly>=h2){gly-=h2;}for(int y=0;y<ky*2;y+=1){for(int x=0;x<kx;x+=1){vec3 value=pickValue_tSrc(gly*KY+float(y),glx*KX+float(x)).rgb;minV=min(minV,value.rgb);maxV=max(maxV,value.rgb);}}if(igly<h2){return vec4(minV,255.0);}else{return vec4(maxV,255.0);}}").Compile({tSrc:t})}(t,n[0]),r=1;r<n.length;r+=1)a=It(a,n[r]);return a},Vt="vec4 operation(float gly,float glx){float x;float y;if(SWAP_COORDS){x=gly;y=glx;}else{x=glx;y=gly;}float _sy=floor(x/SX);float _sx=x-(_sy*SX);float _y=floor(y/WIN_SIZE_X);float _x=y-(_y*WIN_SIZE_X);return pickValue_tSrc(_sy*STRIDE_Y+_y,_sx*STRIDE_X+_x);}",Mt="\n#define WIN_LENGTH WIN_SIZE_X * WIN_SIZE_Y\nvec4 operation(float gly,float glx){float i;if(SWAP_COORDS){i=gly;}else{i=glx;}float x=floor(i/WIN_LENGTH);float y=i-x*WIN_LENGTH;float _sy=floor(x/SX);float _sx=x-(_sy*SX);float _y=floor(y/WIN_SIZE_X);float _x=y-(_y*WIN_SIZE_X);return pickValue_tSrc(_sy*STRIDE_Y+_y,_sx*STRIDE_X+_x);}";function Rt(t,e){if("number"==typeof t&&t>0&&isFinite(t))return[t,t];if(Array.isArray(t)&&2===t.length)return t;throw new Error('Invalid parameter "'.concat(e,'", expected a positive finite number or array with 2 those numbers, but got ').concat(String(t)))}var Lt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=~~(t.shape[0]/e),r=~~(t.shape[1]/e),i=Math.ceil(Math.max(t.shape[0]/a,t.shape[1]/r));return new Q("ReduceMax").Input("tSrc",n?"float32":"uint8").Output("float32").Uniform("uF","float",n).LoadChunk("pickValue").Constant("W",i).Constant("H",i).Constant("O_WIDTH",t.shape[1]).Constant("O_HEIGHT",t.shape[0]).Constant("K",1/i).SetShapeFn((function(){return[Math.ceil(t.shape[0]/i),Math.ceil(t.shape[1]/i),4]})).GLSLKernel("const int w=int(W);const int h=int(H);vec4 operation(float _y,float _x){float mmax=0.0;float maxX=0.0;float maxY=0.0;float sy=_y*H;float sx=_x*W;float yLimit=O_HEIGHT-sy;float xLimit=O_WIDTH-sx;vec4 value;for(float y=0.0;y<H;y+=1.0){if(y>=yLimit){break;}for(float x=0.0;x<W;x+=1.0){if(x>=xLimit){break;}value=pickValue_tSrc(y+sy,x+sx);if(value.r>=mmax){mmax=value.r;if(uF<0.5){maxX=x+sx;maxY=y+sy;}else{maxX=value.g;maxY=value.b;}}}}return vec4(mmax,maxX,maxY,255.0);}").Compile({tSrc:t})},Ot=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=Math.max(t.shape[0],t.shape[1]);return new Q("PCLinesTransform").Input("tSrc","float32").Output("uint8").Uniform("uWidth","float",t.shape[1]).Uniform("uHeight","float",t.shape[0]).Constant("PI",Math.PI).Constant("D",n).Constant("STEP",e).Constant("MAX_DIST",n).Constant("MAX_ANGLE",n).LoadChunk("pickValue").SetShapeFn((function(){return[n,n,4]})).GLSLKernel("precision highp float;float intersectionX(vec4 line,float x){return((x-line.x)/(line.z-line.x)*(line.w-line.y)+line.y);}float intersectionY(vec4 line,float y){return((y-line.y)/(line.w-line.y)*(line.z-line.x)+line.x);}vec4 findSide(float x1,float y1,float x2,float y2){int i=0;vec2 i0=vec2(0,0);vec2 i1=vec2(0,0);float ax=0.0;float ay=intersectionY(vec4(x1,y1,x2,y2),ax);float by=0.0;float bx=intersectionX(vec4(x1,y1,x2,y2),by);float cx=MAX_DIST;float cy=intersectionY(vec4(x1,y1,x2,y2),cx);float dy=MAX_DIST;float dx=intersectionX(vec4(x1,y1,x2,y2),dy);if(ay<=MAX_DIST&&ay>=0.0){if(i==0){i0=vec2(ax,ay);i+=1;}}if(cy<=MAX_DIST&&cy>=0.0){if(i==0){i0=vec2(cx,cy);i+=1;}else{i1=vec2(cx,cy);}}if(bx<=MAX_DIST&&bx>=0.0){if(i==0){i0=vec2(bx,by);i+=1;}else{i1=vec2(bx,by);}}if(dx<=MAX_DIST&&dx>=0.0){if(i==0){i0=vec2(dx,dy);i+=1;}else{i1=vec2(dx,dy);}}return vec4(i0.x,i0.y,i1.x,i1.y);}float pow(float a){return a*a;}vec4 getStraight(float aIndex,float v,float dist,float angles){float y1;float y2;if(aIndex>angles){aIndex-=angles;y1=MAX_ANGLE-(angles*v/aIndex);y2=(-1.0+angles/aIndex)*uWidth+y1;}else{aIndex=angles-aIndex;y1=(angles*v/aIndex);y2=(1.0-angles/aIndex)*uWidth+y1;}return vec4(0.0,y1,uWidth,y2);}float getValue(float i,float lx,float ly,vec4 side){float xx=0.0;float yy=0.0;if(lx<ly){xx=i;yy=intersectionY(side,xx);}else{yy=i;xx=intersectionX(side,yy);}if(xx>0.0&&xx<uWidth&&yy>0.0&&yy<uHeight){float a=pickScalarValue_tSrc(floor(yy),floor(xx));if(a>0.0){return 1.0;}}return 0.0;}vec4 operation(float y,float x){float v_out=0.0;vec4 straight=getStraight(x,y,MAX_DIST,MAX_ANGLE/2.0);vec4 side=findSide(straight.x,straight.y,straight.z,straight.w);float lx=abs(side.z-side.x);float ly=abs(side.w-side.y);float k=1.0/D;for(float i=0.0;i<=D;i+=STEP){float a=getValue(i,lx,ly,side);if(a>0.0){v_out+=k;}}return vec4(v_out,v_out,v_out,255.0);}").Compile({tSrc:t})},Ut=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[2,2],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(b(2===e.length,"Erosion: Kernel size should be shape of rank 2"),M(n)&&b(e[0]===n.shape[0]&&e[1]===n.shape[1],"Erosion: Structure element has wrong size"),!n){n=new it("float32",[e[0],e[1],4]);for(var a=0;a<e[0];a+=1)for(var r=0;r<e[1];r+=1)n.set(a,r,0,1),n.set(a,r,1,1),n.set(a,r,2,1),n.set(a,r,3,1)}return new Q("Erosion").Input("tSrc",t.dtype).Input("tKernel","float32").Output(t.dtype).Constant("KW",e[0]).Constant("KH",e[1]).LoadChunk("pickValue").GLSLKernel("float HKW=floor(KW/2.0);float HKH=floor(KW/2.0);vec4 operation(float y,float x){float R=10000.0;float G=10000.0;float B=10000.0;y=y+HKH;x=x+HKW;for(float dx=0.0;dx<KW;dx+=1.0){for(float dy=0.0;dy<KH;dy+=1.0){vec4 v=pickValue_tSrc((y-dy),(x-dx));vec4 m=pickValue_tKernel(dy,dx);if(v.r<R&&m.r>0.0){R=v.r;}if(v.g<G&&m.g>0.0){G=v.g;}if(v.b<B&&m.b>0.0){B=v.b;}}}return vec4(R,G,B,1.0);}").Compile({tSrc:t,tKernel:n})},Kt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[2,2],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(b(2===e.length,"Dilation: Kernel size should be shape of rank 2"),M(n)&&b(e[0]===n.shape[0]&&e[1]===n.shape[1],"Dilation: Structure element has wrong size"),!n){n=new it("float32",[e[0],e[1],4]);for(var a=0;a<e[0];a+=1)for(var r=0;r<e[1];r+=1)n.set(a,r,0,1),n.set(a,r,1,1),n.set(a,r,2,1),n.set(a,r,3,1)}return new Q("Dilation").Input("tSrc",t.dtype).Input("tKernel","float32").Output(t.dtype).Constant("KW",e[0]).Constant("KH",e[1]).LoadChunk("pickValue").GLSLKernel("float HKW=floor(KW/2.0);float HKH=floor(KW/2.0);vec4 operation(float y,float x){float R=0.0;float G=0.0;float B=0.0;y=y+HKH;x=x+HKW;for(float dx=0.0;dx<KW;dx+=1.0){for(float dy=0.0;dy<KH;dy+=1.0){vec4 v=pickValue_tSrc((y-dy),(x-dx));vec4 m=pickValue_tKernel(dy,dx);if(v.r>R&&m.r>0.0){R=v.r;}if(v.g>G&&m.g>0.0){G=v.g;}if(v.b>B&&m.b>0.0){B=v.b;}}}return vec4(R,G,B,1.0);}").Compile({tSrc:t,tKernel:n})},Pt=function(t,e,n){b(M(e)||A(e),"".concat(t,": A input is not a Tensor or Operation instance")),b(M(n)||A(n),"".concat(t,": B input is not a Tensor or Operation instance")),b(e.dtype===n.dtype,"".concat(t,": inputs should have the same dtype, got ").concat(e.dtype," and ").concat(n.dtype)),b(e.shape[0]===n.shape[0]&&e.shape[1]===n.shape[1]&&e.shape[3]===n.shape[3],"".concat(t,": inputs should have the same shapes, got ").concat(e.shape," and ").concat(n.shape))},Ft=function(t,e,n){b("number"==typeof n,"".concat(t,": scalar value is not a number")),b(M(e)||A(e),"".concat(t,": A input is not a Tensor or Operation instance"))},Dt=function(t,e){return Pt("Sub",t,e),new Q("Sub").Input("tA",t).Input("tB",e).Output(t.dtype).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);vec4 B=pickValue_tB(y,x);return vec4(A.rgb-B.rgb,1.0);}").Compile({tA:t,tB:e})},Gt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"x",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new Q("SummedAreaTable").Input("tSrc",t.dtype).Output("float32").LoadChunk("pickValue").Constant("PASSI",n).Constant("LAST",!1).Constant("SAMPLES_PER_PASS",a).GLSLKernel("x"===e?"vec4 operation(float y,float x){vec4 res=pickValue_tSrc(y,x);for(float I=1.0;I<=SAMPLES_PER_PASS;I+=1.0){float cx=x-ceil(pow(1.0+SAMPLES_PER_PASS,PASSI)*I);if(cx<0.0){break;}res+=pickValue_tSrc(y,cx);}return res;}":"vec4 operation(float y,float x){vec4 res=pickValue_tSrc(y,x);for(float I=1.0;I<=SAMPLES_PER_PASS;I+=1.0){float cy=y-ceil(pow(1.0+SAMPLES_PER_PASS,PASSI)*I);if(cy<0.0){break;}res+=pickValue_tSrc(cy,x);}return res;}").Compile({tSrc:t})},Ht=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=Math.ceil(Math.pow(t.shape[1],1/e)),r=Math.ceil(Math.pow(t.shape[0],1/e)),i=t,o=Math.log(t.shape[1])/Math.log(Math.max(a+1,2)),s=Math.log(t.shape[0])/Math.log(Math.max(r+1,2));n&&(i=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return new Q("SquaredSummedAreaTable").Input("tSrc",t.dtype).Output("float32").LoadChunk("pickValue").Constant("PASSI",e).Constant("LAST",!1).Constant("SAMPLES_PER_PASS",n).GLSLKernel("vec4 operation(float y,float x){vec4 res=pickValue_tSrc(y,x);res=res*res;vec4 v=vec4(0.0);for(float I=1.0;I<=SAMPLES_PER_PASS;I+=1.0){float cx=x-ceil(pow(1.0+SAMPLES_PER_PASS,PASSI)*I);if(cx<0.0){break;}v=pickValue_tSrc(y,cx);res+=v*v;}return res;}").Compile({tSrc:t})}(i,0,Math.min(a,t.shape[1]-1)));for(var l=n?1:0;l<o;l+=1)i=Gt(i,"x",l,Math.min(a,t.shape[1]-1));for(var u=0;u<s;u+=1)i=Gt(i,"y",u,Math.min(r,t.shape[0]-1));return i},Wt=function(t){return Ht(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,!1)},Xt=1e-7;function Bt(t,e,n){return t-Xt<=e&&e<=n+Xt}var Nt=function(){function t(e,a,r,i,o,s){if(n(this,t),e instanceof ArrayBuffer)this.data=new Float32Array(e,a,8);else if(Array.isArray(e)){if(e.length<8)for(var l=e.length;l<=8;l+=1)e.push(0);this.data=new Float32Array(e)}else this.data=void 0!==e&&void 0!==a?new Float32Array([e,a,r,i,o,s,0,0]):new Float32Array(8)}return r(t,[{key:"set",value:function(t,e,n,a,r,i){this.data[0]=t,this.data[1]=e,this.data[2]=n,this.data[3]=a,this.data[4]=r,this.data[5]=i,this.data[6]=0,this.data[7]=0}},{key:"fromParallelCoords",value:function(t,e,n,a,r,i){var o,s,l=n;s=t>i?(i/(t-=i)-1)*n+(o=r-i*e/t):(1-i/(t=i-t))*n+(o=i*e/t),this.set(0,o,l,s,t,e)}},{key:"length",get:function(){if(this.data[6])return this.data[6];var t=this.data[2]-this.data[0],e=this.data[3]-this.data[1],n=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return this.data[6]=n,n}},{key:"angle",get:function(){if(this.data[7])return this.data[7];var t=this.data[2]-this.data[0],e=this.data[3]-this.data[1],n=Math.atan(e/t)/Math.PI*180;return n<0&&(n=180+n),this.data[7]=n,n}},{key:"x1",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y1",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"x2",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"y2",get:function(){return this.data[3]},set:function(t){this.data[3]=t}},{key:"px",get:function(){return this.data[4]},set:function(t){this.data[4]=t}},{key:"py",get:function(){return this.data[5]},set:function(t){this.data[5]=t}},{key:"clear",value:function(){this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=0,this.data[6]=0,this.data[7]=0}},{key:"fromArray",value:function(t){this.data.set(t)}},{key:"toArray",value:function(){return Array.prototype.slice.call(this.data)}}],[{key:"Intersection",value:function(t,e){var n=t.x1,a=t.y1,r=t.x2,i=t.y2,o=e.x1,s=e.y1,l=e.x2,u=e.y2,c=((n*i-a*r)*(o-l)-(n-r)*(o*u-s*l))/((n-r)*(s-u)-(a-i)*(o-l)),h=((n*i-a*r)*(s-u)-(a-i)*(o*u-s*l))/((n-r)*(s-u)-(a-i)*(o-l));if(isNaN(c)||isNaN(h))return!1;if(n>=r){if(!Bt(r,c,n))return!1}else if(!Bt(n,c,r))return!1;if(a>=i){if(!Bt(i,h,a))return!1}else if(!Bt(a,h,i))return!1;if(o>=l){if(!Bt(l,c,o))return!1}else if(!Bt(o,c,l))return!1;if(s>=u){if(!Bt(u,h,s))return!1}else if(!Bt(s,h,u))return!1;return[c,h]}}]),t}();function zt(t,e){var n=t[2]-t[0],a=t[3]-t[1],r=e[2]-e[0],i=e[3]-e[1],o=n*r+a*i,s=(n*n+a*a)*(r*r+i*i);return Math.acos(o/Math.sqrt(s))}function jt(t,e,n){var a,r=n,i=0,o=0,s=0;return i=r.get(0,1)*e+r.get(0,2),o=r.get(1,1)*e+r.get(1,2),s=r.get(2,1)*e+r.get(2,2),i+=r.get(0,0)*t,o+=r.get(1,0)*t,[i*(a=1/(s+=r.get(2,0)*t)),o*a]}function Yt(t,e,n,a,r){var i=(n-1)*t.stride[0],o=(n+r)*t.stride[0],s=4*(e-1),l=4*(e+a);return t.data[o+l]-(n>0?t.data[i+l]:0)-(e>0?t.data[o+s]:0)+(n>0&&e>0?t.data[i+s]:0)}Nt.BYTES_PER_ELEMENT=36;var qt=function(){function t(){n(this,t);for(var e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];a[0]instanceof ArrayBuffer?this.data=new Float32Array(a[0],a[1],t.NUM_ELEMENTS):Array.isArray(a[0])?this.data=new Float32Array(a[0]):a[0]&&a.length===t.NUM_ELEMENTS?this.data=new Float32Array(a):this.data=new Float32Array(t.NUM_ELEMENTS)}return r(t,[{key:"isInRect",value:function(e,n){return!(t.TriangleS(e,n,this.ax,this.ay,this.bx,this.by)+t.TriangleS(e,n,this.cx,this.cy,this.bx,this.by)+t.TriangleS(this.cx,this.cy,e,n,this.dx,this.dy)+t.TriangleS(this.dx,this.dy,e,n,this.ax,this.ay)-this.area>0)}},{key:"isNotEmpty",value:function(){return this.data[0]>0&&this.data[1]>0&&this.data[2]>0&&this.data[3]>0&&this.data[4]>0&&this.data[5]>0&&this.data[6]>0&&this.data[7]>0}},{key:"clone",value:function(){return new t(this.toArray())}},{key:"set",value:function(t,e,n,a,r,i,o,s){this.data[0]=t,this.data[1]=e,this.data[2]=n,this.data[3]=a,this.data[4]=r,this.data[5]=i,this.data[6]=o,this.data[7]=s}},{key:"assign",value:function(t){return this.data.set(t.data),this}},{key:"scale",value:function(t,e){return this.data[0]*=t,this.data[1]*=e,this.data[2]*=t,this.data[3]*=e,this.data[4]*=t,this.data[5]*=e,this.data[6]*=t,this.data[7]*=e,this}},{key:"fromLines",value:function(t,e,n,a){var r=function(t,e){var n=[0,0],a=null,r=null,i=null,o=null;n[0]+=t[0][0],n[0]+=t[1][0],n[0]+=t[2][0],n[0]+=t[3][0],n[1]+=t[0][1],n[1]+=t[1][1],n[1]+=t[2][1],n[1]+=t[3][1],n[0]/=4,n[1]/=4;for(var s=0;s<t.length;s+=1)t[s][0]>=n[0]&&t[s][1]>=n[1]&&(i=t[s]),t[s][0]<=n[0]&&t[s][1]<=n[1]&&(a=t[s]),t[s][0]>=n[0]&&t[s][1]<=n[1]&&(r=t[s]),t[s][0]<=n[0]&&t[s][1]>=n[1]&&(o=t[s]);return[a,r,i,o]}([Nt.Intersection(t,e),Nt.Intersection(e,n),Nt.Intersection(n,a),Nt.Intersection(a,t)]);return!!(r[0]&&r[1]&&r[2]&&r[3])&&(this.data[0]=r[0][0],this.data[1]=r[0][1],this.data[2]=r[1][0],this.data[3]=r[1][1],this.data[4]=r[2][0],this.data[5]=r[2][1],this.data[6]=r[3][0],this.data[7]=r[3][1],!0)}},{key:"ax",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"ay",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"bx",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"by",get:function(){return this.data[3]},set:function(t){this.data[3]=t}},{key:"cx",get:function(){return this.data[4]},set:function(t){this.data[4]=t}},{key:"cy",get:function(){return this.data[5]},set:function(t){this.data[5]=t}},{key:"dx",get:function(){return this.data[6]},set:function(t){this.data[6]=t}},{key:"dy",get:function(){return this.data[7]},set:function(t){this.data[7]=t}},{key:"distA",get:function(){return Math.sqrt(Math.pow(this.data[6]-this.data[0],2)+Math.pow(this.data[7]-this.data[1],2))}},{key:"distB",get:function(){return Math.sqrt(Math.pow(this.data[4]-this.data[2],2)+Math.pow(this.data[5]-this.data[3],2))}},{key:"distC",get:function(){return Math.sqrt(Math.pow(this.data[0]-this.data[2],2)+Math.pow(this.data[1]-this.data[3],2))}},{key:"distD",get:function(){return Math.sqrt(Math.pow(this.data[6]-this.data[4],2)+Math.pow(this.data[7]-this.data[5],2))}},{key:"distE",get:function(){return Math.sqrt(Math.pow(this.data[0]-this.data[4],2)+Math.pow(this.data[1]-this.data[5],2))}},{key:"distF",get:function(){return Math.sqrt(Math.pow(this.data[6]-this.data[2],2)+Math.pow(this.data[7]-this.data[3],2))}},{key:"angleA",get:function(){return zt([this.data[6],this.data[7],this.data[0],this.data[1]],[this.data[0],this.data[1],this.data[2],this.data[3]])}},{key:"angleB",get:function(){return zt([this.data[0],this.data[1],this.data[2],this.data[3]],[this.data[2],this.data[3],this.data[4],this.data[5]])}},{key:"angleC",get:function(){return zt([this.data[2],this.data[3],this.data[4],this.data[5]],[this.data[4],this.data[5],this.data[6],this.data[7]])}},{key:"angleD",get:function(){return zt([this.data[4],this.data[5],this.data[6],this.data[7]],[this.data[6],this.data[7],this.data[0],this.data[1]])}},{key:"area",get:function(){var t=this.distA,e=this.distB,n=this.distC,a=this.distD,r=(t+e+n+a)/2;return Math.sqrt((r-t)*(r-e)*(r-n)*(r-a))}},{key:"P",get:function(){return this.distA+this.distB+this.distC+this.distD}},{key:"mul",value:function(t){return this.data[0]*=t,this.data[1]*=t,this.data[2]*=t,this.data[3]*=t,this.data[4]*=t,this.data[5]*=t,this.data[6]*=t,this.data[7]*=t,this}},{key:"scaleAt",value:function(t){return this.data[0]-=t,this.data[1]-=t,this.data[2]-=t,this.data[3]+=t,this.data[4]+=t,this.data[5]+=t,this.data[6]+=t,this.data[7]-=t,this}},{key:"clear",value:function(){this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=0,this.data[6]=0,this.data[7]=0}},{key:"fromDeep",value:function(t){return this.data[0]=t[0][0],this.data[1]=t[0][1],this.data[2]=t[1][0],this.data[3]=t[1][1],this.data[4]=t[2][0],this.data[5]=t[2][1],this.data[6]=t[3][0],this.data[7]=t[3][1],this}},{key:"perspective",value:function(t){var e=jt(this.data[0],this.data[1],t),n=jt(this.data[2],this.data[3],t),a=jt(this.data[4],this.data[5],t),r=jt(this.data[6],this.data[7],t);return this.data[0]=e[0],this.data[1]=e[1],this.data[2]=n[0],this.data[3]=n[1],this.data[4]=a[0],this.data[5]=a[1],this.data[6]=r[0],this.data[7]=r[1],this}},{key:"fromArray",value:function(t){return this.data.set(t),this}},{key:"toArray",value:function(){return Array.prototype.slice.call(this.data)}},{key:"isInside",value:function(t){return t.ax>this.ax&&t.ay>this.ay&&t.bx<this.bx&&t.by>this.by&&t.cx<this.cx&&t.cy<this.cy&&t.dx>this.dx&&t.dy<this.dy}},{key:"toJSON",value:function(){return this.toArray()}}],[{key:"Distance",value:function(t,e){for(var n=0,a=0;a<8;a+=2){var r=Math.sqrt(Math.pow(t.data[a]-e.data[a],2)+Math.pow(t.data[a+1]-e.data[a+1],2));n+=Math.pow(r,2)}return(n=Math.sqrt(n/8))===1/0?0:n}},{key:"TriangleS",value:function(t,e,n,a,r,i){return Math.abs(t*(a-i)+n*(i-e)+r*(e-a))/2}}]),t}();qt.NUM_ELEMENTS=8,qt.BYTES_PER_ELEMENT=qt.NUM_ELEMENTS*Float32Array.BYTES_PER_ELEMENT;var Zt=function(){function t(e,a){n(this,t),this.dataStore=new ArrayBuffer(a*e.BYTES_PER_ELEMENT),this.data=new Array(a),this.size=a;for(var r=0;r<a;r+=1)this.data[r]=new e(this.dataStore,r*e.BYTES_PER_ELEMENT);this.length=0}return r(t,[{key:"map",value:function(t,e){return this.data.map(t,e)}},{key:"push",value:function(t){if(!(this.length<this.size))throw new Error("Typed Pool size exceed");this.data[this.length].data.set(t.data),this.length+=1}},{key:"at",value:function(t){if(t>=this.size)throw new Error("Out of range requested");return this.data[t]}},{key:"release",value:function(t){if(this.length=0,t)for(var e=0;e<this.size;e+=1)this.data[e].clear()}}]),t}();t.CaptureVideo=ht,t.DeprecationError=P,t.GLTexture=$,t.HSVColor=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"rgb_to_hsv";b("rgb_to_hsv"===e||"hsv_to_rgb"===e,"Unsupported type ".concat(e,", currenlty avaliable: rgb_to_hsv, hsv_to_rgb."));var n=null;return"rgb_to_hsv"===e&&(n="vec3 rgb2hsv(vec3 c){vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.0*d+e)),d/(q.x+e),q.x);}vec4 operation(float y,float x){return vec4(rgb2hsv(pickValue_tSrc(y,x).rgb),1);}"),"hsv_to_rgb"===e&&(n="vec3 hsv2rgb(vec3 c){vec4 K=vec4(1.0,2.0/3.0,1.0/3.0,3.0);vec3 p=abs(fract(c.xxx+K.xyz)*6.0-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.0,1.0),c.y);}vec4 operation(float y,float x){return vec4(hsv2rgb(pickValue_tSrc(y,x).rgb),1);}"),new Q("HSV").Input("tSrc",t.dtype).Output(t.dtype).LoadChunk("pickValue").GLSLKernel(n).Compile({tSrc:t})},t.Line=Nt,t.MediaInput=ot,t.Operation=Z,t.Rect=qt,t.RegisterOperation=Q,t.Session=J,t.Tensor=it,t.TypedPool=Zt,t.adaptiveThreshold=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Wt(t);return b("number"==typeof n,"Only number available as a threshold value."),b("number"==typeof e,"Only number available as a size value."),b(0===a||1===a||2===a||3===a,"Only RGBA available: 0, 1, 2, 3"),new Q("Threshold").Input("tSrc",t.dtype).Input("tIntegralImage",r.dtype).Output(t.dtype).Constant("C",a).Uniform("uS","float",e).Uniform("uT","float",n).LoadChunk("pickValue").GLSLKernel("const int Channel=int(C);float pickValue(float y,float x){if(y<0.0||x<0.0){return 0.0;}return pickValue_tIntegralImage(y,x)[Channel];}vec4 operation(float y,float x){vec4 pixel=pickValue_tSrc(y,x);float huS=uS/2.0;vec2 p1=max(floor(vec2(x,y)-huS),vec2(0.0));vec2 p2=min(floor(vec2(x,y)+huS),OUT_VIEW-1.0);vec2 pd=p2+1.0-p1;float s=pd.x*pd.y;p1-=1.0;float sum=pickValue(p2.y,p2.x)-pickValue(p1.y,p2.x)-pickValue(p2.y,p1.x)+pickValue(p1.y,p1.x);if(pixel[Channel]*s<=sum*(100.0-uT)/100.0){return vec4(0.0,0.0,0.0,1.0);}else{return vec4(1.0,1.0,1.0,1.0);}}").Compile({tSrc:t,tIntegralImage:r})},t.add=function(t,e){return Pt("Add",t,e),new Q("Add").Input("tA",t).Input("tB",e).Output(t.dtype).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);vec4 B=pickValue_tB(y,x);return vec4(A.rgb+B.rgb,1.0);}").Compile({tA:t,tB:e})},t.addScalar=function(t,e){var n="AddScalar";return Ft(n,t,e),new Q(n).Input("tA",t).Output(t.dtype).Uniform("uScalar","float",e).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);return vec4(A.rgb+uScalar,1.0);}").Compile({tA:t})},t.assert=b,t.assertCreateElement=E,t.assertDOMFeature=_,t.assertOffsetCanvas=C,t.assertQuerySelector=w,t.assertShapesAreEqual=T,t.calcHAARFeature=function(t,e,n,a,r,i){for(var o=0,s=n/i,l=0;l<e.length;l+=1)o+=Yt(t,~~(e[l][0]*s)+a,~~(e[l][1]*s)+r,~~(e[l][2]*s)-1,~~(e[l][3]*s)-1)*e[l][4];return o},t.calcIntegralSum=Yt,t.cannyEdges=function(t){var e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.25,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.75;return function(t,e,n){return b(e>=0,"Canny low threshold should be greater equal 0"),b(n<=1,"Canny high threshold should be less equal 1"),new Q("ImageCannyEdgesHysteresis").Input("tSrc",t.dtype).Output(t.dtype).LoadChunk("pickValue").Uniform("uSize","float",1).Uniform("uThresholdLow","float",e).Uniform("uThresholdHigh","float",n).GLSLKernel("\n#define STROKE uSize\nvec4 operation(float y,float x){vec4 M=pickValue_tSrc(y,x);float N=pickValue_tSrc(y+STROKE,x).r;float S=pickValue_tSrc(y-STROKE,x).r;float W=pickValue_tSrc(y,x-STROKE).r;float E=pickValue_tSrc(y,x+STROKE).r;float SE=pickValue_tSrc(y-STROKE,x+STROKE).r;float NW=pickValue_tSrc(y+STROKE,x-STROKE).r;float NE=pickValue_tSrc(y+STROKE,x+STROKE).r;float SW=pickValue_tSrc(y-STROKE,x-STROKE).r;float V=M.r;float H=0.0;if(V>uThresholdHigh){H+=1.0;}if(V>uThresholdLow&&V<uThresholdHigh){if(N>0.0||S>0.0||W>0.0||E>0.0||SE>0.0||NW>0.0||NE>0.0||SW>0.0){H+=1.0;}}if(H==1.0){return vec4(255,255,255,255);}else{return vec4(0,0,0,255);}}").Compile({tSrc:t})}((e=t,new Q("ImageCannyEdgesNMS").Input("tSrc",e.dtype).Output(e.dtype).LoadChunk("pickValue").Uniform("uSize","float",1).Constant("PI",Math.PI).GLSLKernel("\n#define STROKE uSize\nvec4 operation(float y,float x){vec4 M=pickValue_tSrc(y,x);float N=pickValue_tSrc(y+STROKE,x).r;float S=pickValue_tSrc(y-STROKE,x).r;float W=pickValue_tSrc(y,x-STROKE).r;float E=pickValue_tSrc(y,x+STROKE).r;float SE=pickValue_tSrc(y-STROKE,x+STROKE).r;float NW=pickValue_tSrc(y+STROKE,x-STROKE).r;float NE=pickValue_tSrc(y+STROKE,x+STROKE).r;float SW=pickValue_tSrc(y-STROKE,x-STROKE).r;float H=0.0;float V=M.r;float dx=M.g;float dy=M.b;float theta=atan(dy/dx);float deg=theta*(180.0/PI);float angle=0.0;if(deg<0.0){deg=180.0+deg;}if(deg<22.5||deg>=157.5){if(V>W&&V>E){H+=1.0;}}if(deg<67.5&&deg>=22.5){if(V>SW&&V>NE){H+=1.0;}}if(deg<112.5&&deg>=67.5){if(V>N&&V>S){H+=1.0;}}if(deg<157.5&&deg>=112.5){if(V>NW&&V>SE){H+=1.0;}}if(H==1.0){return vec4(V,V,V,255);}else{return vec4(0,0,0,255);}}").Compile({tSrc:e})),n,a)},t.canvasClear=function(t){t.width=t.width,t.height=t.height},t.canvasCreate=function(t,e){var n=D();return n.width=t,n.height=e,n},t.canvasDrawCircle=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#ff0000",r=t.getContext("2d");r.beginPath(),r.arc(e[0],e[1],n,0,2*Math.PI),r.strokeStyle=a,r.stroke()},t.canvasDrawLine=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"rgba(255, 0, 0, 0.5)",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=t.getContext("2d");r.beginPath(),Array.isArray(e)?(r.moveTo(e[0],e[1]),r.lineTo(e[2],e[3])):(r.moveTo(e.data[0],e.data[1]),r.lineTo(e.data[2],e.data[3])),r.strokeStyle=n,r.lineWidth=a,r.stroke(),r.closePath()},t.canvasDrawRect=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"rgba(255, 0, 0, 1)",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=t.getContext("2d");o.beginPath(),o.moveTo(e.ax,e.ay),o.lineTo(e.bx,e.by),o.lineTo(e.cx,e.cy),o.lineTo(e.dx,e.dy),o.lineTo(e.ax,e.ay),r&&(o.lineTo(e.ax,e.ay),o.lineTo(e.cx,e.cy),o.lineTo(e.bx,e.by),o.lineTo(e.dx,e.dy),o.lineTo(e.ax,e.ay)),o.strokeStyle=n,i&&(o.fillStyle=n,o.fill()),o.stroke(),o.lineWidth=a,o.closePath()},t.canvasFill=function(t,e){var n=t.getContext("2d");n.fillStyle=e,n.fillRect(0,0,t.width,t.height)},t.canvasFillCircle=function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#ff0000",r=t.getContext("2d");r.beginPath(),r.arc(e[0],e[1],n,0,2*Math.PI),r.fillStyle=a,r.fill()},t.canvasFromTensor=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!(e instanceof it))throw Error("tensorToCanvas: Input tensor invalid");e.shape[2]&&4===e.shape[2]&&(n=!0);var r=st(e,n,a);t.getContext("2d").putImageData(r,0,0)},t.canvasInit=function(t,e,n){w();var a=document.querySelector(t);return a.width=e,a.height=n,a},t.canvasToTensor=function(t,e){var n=t.getContext("2d").getImageData(0,0,e.shape[1],e.shape[0]);if(e)switch(e.dtype){case"uint8":e.assign(new Uint8Array(n.data));break;case"uint8c":e.assign(n.data);break;default:e.assign(new Float32Array(n.data))}},t.cast=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.dtype;return new Q("Cast").Input("tSrc",t.dtype).Output(e).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){return pickValue_tSrc(y,x);}").Compile({tSrc:t})},t.clearCanvas=function(t){t.getContext("2d").clearRect(0,0,t.width,t.height)},t.colorSegmentation=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return b("uint8"===t.dtype,"Color Segmentation currently available for uint8 image input"),b(e>1,"Number of clusters should be greater than 1"),new Q("ImageColorSegmentation").Input("tSrc","uint8").Input("tCentroids","uint8").Output("uint8").LoadChunk("pickValue").Constant("CLUSTERS",e).GLSLKernel("const float _step=1.0/CLUSTERS;vec4 operation(float y,float x){float minDistance=256.0;float label=0.0;vec3 value=pickValue_tSrc(y,x).rgb;for(int i=0;i<int(CLUSTERS);i+=1){vec3 curr=pickValue_tCentroids(float(i),0.0).rgb;float distance=sqrt(((value.r-curr.r)*(value.r-curr.r)));if(distance<minDistance){minDistance=distance;label=float(i)/CLUSTERS;}}return vec4(label,label,label,1.0);}").PreCompile((function(t){var n=~~(256/e);t.centroids=new it("uint8",[e,1,4]);for(var a=0;a<e;a+=1)t.centroids.set(a,0,0,a*n);t.assignInput("tCentroids",t.centroids)})).Compile({tSrc:t})},t.concat=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["1.r","1.g","2.b","2.a"];b(t.dtype===e.dtype,"Concat operation: inputs should have the same dtype, got ".concat(t.dtype," and ").concat(e.dtype)),b(4===n.length,"Concat operation: wrong input");for(var a=0;a<n.length;a+=1)b("string"==typeof n[a]||!/^\d\.(r|g|b|a|x|y|z|w)$/.test(n[a]),"Concat operation: wrong input");return new Q("Concat").Input("tA",t).Input("tB",e).Output(t.dtype).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 chanels1=pickValue_tA(y,x);vec4 chanels2=pickValue_tB(y,x);return RESULT;}".replace("RESULT","vec4(".concat(n.map((function(t){return"chanels".concat(t)})).join(", "),")"))).Compile({tA:t,tB:e})},t.conv2d=pt,t.deprecationError=function(t,e){throw new P('GammaCV Deprecation Error: "'.concat(t,'" is deprecated').concat(e?", ".concat(e):"",'. "').concat(t,'" and was removed.'))},t.deprecationWarning=F,t.dilate=Kt,t.div=function(t,e){return Pt("Div",t,e),new Q("Div").Input("tA",t).Input("tB",e).Output(t.dtype).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);vec4 B=pickValue_tB(y,x);return vec4(A.rgb/B.rgb,1.0);}").Compile({tA:t,tB:e})},t.divScalar=function(t,e){var n="DivScalar";return Ft(n,t,e),new Q(n).Input("tA",t).Output(t.dtype).Uniform("uScalar","float",e).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);return vec4(A.rgb/uScalar,1.0);}").Compile({tA:t})},t.downsample=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nearest",a=~~(t.shape[1]/e),r=~~(t.shape[0]/e);return yt(t,a,r,n)},t.erode=Ut,t.flipTensor=nt,t.gaussianBlur=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;return b(e>=3,"Kernel size should be greater equal 3"),b(n>0,"Sigma should be greater then 0"),pt(t,ft(e,n))},t.generateTransformMatrix=function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return function(t,e,n,a,r,i,o,s,l,u,c,h,f,d,p,v,y){var g=arguments.length>17&&void 0!==arguments[17]&&arguments[17],x=e,m=u,S=o,k=x*m*S,b=p,T=x*b,_=m*T,E=c,w=x*E,C=i,I=n,A=d,V=I*A,M=V*C,R=A*C*E,L=A*S,O=A*E,U=m*S,K=b*m,P=b*C,F=E*C,D=1/(L-O-U+K-P+F),G=x*A,H=I*C,W=S*x,X=b*W,B=I*m,N=V*E,z=I*E*C,j=S*b*m,Y=b*I,q=-(_-k+w*C-C*T-V*m+M-R+L*m)*D,Z=(k-_-G*S+G*E+M-m*H+P*m-R)*D,$=x,J=(-E*T+X+B*S-V*S+N-z+P*E-j)*D,Q=(W*E-X-Y*m+N-z+Y*C+j-L*E)*D,tt=I,et=(-w+W+B-H+O-L-K+P)*D,nt=(-T+w+V-B+P-F-L+U)*D,at=-((_=(m=h)*(T=(x=a)*(b=y)))-(k=x*m*(S=l))+(w=x*(E=f))*(C=s)-C*T-(V=(I=r)*(A=v))*m+(M=V*C)-(R=A*C*E)+(L=A*S)*m)*(D=1/(L-(O=A*E)-(U=m*S)+(K=b*m)-(P=b*C)+(F=E*C))),rt=(k-_-(G=x*A)*S+G*E+M-m*(H=I*C)+P*m-R)*D,it=x,ot=(-E*T+(X=b*(W=S*x))+(B=I*m)*S-V*S+(N=V*E)-(z=I*E*C)+P*E-(j=S*b*m))*D,st=(W*E-X-(Y=b*I)*m+N-z+Y*C+j-L*E)*D,lt=I,ut=(-w+W+B-H+O-L-K+P)*D,ct=(-T+w+V-B+P-F-L+U)*D,ht=$*et;M=tt*et-J;var ft=-J*nt+Q*et,dt=q-ht;H=q*nt-(w=Z*et);var pt=(k=q*tt)-(_=$*J),vt=(S=q*Q)-(T=J*Z);z=(m=Q-nt*tt)*(A=1/(S-k*nt-T+_*nt+w*tt-ht*Q));var yt=(F=$*nt-Z)*A,gt=(W=-Z*tt+$*Q)*A,xt=t.data;g?(xt[0]=at*z+rt*(M*A)-it*(ft*A),xt[1]=at*yt+rt*(dt*A)-it*(H*A),xt[2]=-at*gt-rt*(pt*A)+it*(vt*A),xt[4]=ot*z+st*(M*A)-lt*(ft*A),xt[5]=ot*yt+st*(dt*A)-lt*(H*A),xt[6]=-ot*gt-st*(pt*A)+lt*(vt*A),xt[8]=ut*z+ct*(M*A)-ft*A,xt[9]=ut*yt+ct*(dt*A)-H*A,xt[10]=-ut*gt-ct*(pt*A)+vt*A):(xt[0]=at*z+rt*(M*A)-it*(ft*A),xt[1]=at*yt+rt*(dt*A)-it*(H*A),xt[2]=-at*gt-rt*(pt*A)+it*(vt*A),xt[3]=ot*z+st*(M*A)-lt*(ft*A),xt[4]=ot*yt+st*(dt*A)-lt*(H*A),xt[5]=-ot*gt-st*(pt*A)+lt*(vt*A),xt[6]=ut*z+ct*(M*A)-ft*A,xt[7]=ut*yt+ct*(dt*A)-H*A,xt[8]=-ut*gt-ct*(pt*A)+vt*A)}(n,a,a,t.ax,t.ay,e[1]-a,a,t.bx,t.by,e[1]-a,e[0]-a,t.cx,t.cy,a,e[0]-a,t.dx,t.dy,3===n.shape.length&&4===n.shape[2]),n},t.getCanvas=D,t.getImage=G,t.getImageData=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.width,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:t.height;return t.getContext("2d").getImageData(e,n,a,r)},t.getVideo=H,t.grayscale=function(t){return new Q("Grayscale").Input("tSrc","uint8").Output("uint8").LoadChunk("pickValue").GLSLKernel("const vec3 k=vec3(0.2128,0.7148,0.0724);vec4 operation(float y,float x){float value=dot(pickValue_tSrc(y,x).rgb,k);return vec4(value,value,value,1.0);}").Compile({tSrc:t})},t.histogram=Ct,t.histogramEqualization=function(t){return function(t,e){return new Q("histogramEqualization").Input("tSrc","uint8").Input("tHist","float32").Output("uint8").LoadChunk("pickValue").GLSLKernel("const float norm=1.0/(OUT_VIEW.x*OUT_VIEW.y);vec4 operation(float y,float x){vec4 histBase=pickValue_tSrc(y,x)*255.0;float r=pickValue_tHist(0.0,histBase.r).r;float g=pickValue_tHist(0.0,histBase.g).g;float b=pickValue_tHist(0.0,histBase.b).b;float a=pickValue_tHist(0.0,histBase.a).a;return vec4(r,g,b,255.0/norm)*norm;}").Compile({tSrc:t,tHist:e})}(t,function(t){return new Q("histogramCumulation").Input("tSrc","float32").Output("float32").LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 sum=vec4(0.0);for(float i=0.0;i<255.0;i+=1.0){vec4 value=pickValue_tSrc(0.0,i);if(i<=x){sum+=value;}else{break;}}return sum;}").Compile({tSrc:t})}(Ct(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:2)))},t.hog=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"max";b("max"===n||"visualize"===n,"Unsupported type of HOG operation.\n     Currently availiable max and visualize.");var a=null;return"max"===n&&(a=function(t,e){return new Q("HOGMax").Input("tSrc","uint8").Output("float32").Uniform("uSrcWidth","float",t.shape[1]).Uniform("uSrcHeight","float",t.shape[0]).Uniform("uWidth","float",~~(t.shape[1]/e)).Uniform("uHeight","float",~~(t.shape[0]/e)).Constant("PI",Math.PI).Constant("W",~~(t.shape[1]/e)).Constant("H",~~(t.shape[0]/e)).Constant("K",e).LoadChunk("pickValue").SetShapeFn((function(){return[~~(t.shape[0]/e),~~(t.shape[1]/e),4]})).GLSLKernel("const int w=int(W);const int h=int(H);const int k=int(K);const float S=3.0;float A=180.0/9.0;vec4 getPixel(float y,float x){float x1=x/float(w);float y1=y/float(h);return pickValue_tSrc(floor(y1*uSrcHeight),floor(x1*uSrcWidth));}vec4 getPixel(float y,float x,float xOffset,float yOffset){float x1=x/float(w);float y1=y/float(h);return pickValue_tSrc(floor(y1*uSrcHeight)+yOffset,floor(x1*uSrcWidth)+xOffset);}vec4 operation(float y,float x){float x1=x/W;float y1=y/H;float res=0.0;float tmpx=x/S;float tmpy=y/S;float sum[9];int count=0;vec4 value=getPixel(y,x);for(int _x=0;_x<k;_x+=1){for(int _y=0;_y<k;_y+=1){vec4 v=getPixel(y,x,float(_y),float(_x));float theta=abs(PI/2.0-v.g);float deg=theta*(180.0/PI);int i=int(floor(deg/A));if(i==1){sum[1]+=v.r;}if(i==2){sum[2]+=v.r;}if(i==3){sum[3]+=v.r;}if(i==4){sum[4]+=v.r;}if(i==5){sum[5]+=v.r;}if(i==6){sum[6]+=v.r;}if(i==7){sum[7]+=v.r;}if(i==8){sum[8]+=v.r;}}}int maxI=0;float maxV=0.0;for(int i=0;i<9;i++){if(maxV<sum[i]){maxI=i;maxV=sum[i];}}return vec4(maxI,maxV,0.0,0.0);}").Compile({tSrc:t})}(gt(t),e)),"visualize"===n&&(a=function(t,e){return new Q("HOG").Input("tSrc","uint8").Output("float32").Uniform("uSrcWidth","float",t.shape[1]).Uniform("uSrcHeight","float",t.shape[0]).Uniform("uWidth","float",3*~~(t.shape[1]/e)).Uniform("uHeight","float",3*~~(t.shape[0]/e)).Constant("PI",Math.PI).Constant("W",~~(t.shape[1]/e)).Constant("H",~~(t.shape[0]/e)).Constant("K",e).LoadChunk("pickValue").SetShapeFn((function(){return[3*~~(t.shape[0]/e),3*~~(t.shape[1]/e),4]})).GLSLKernel("float A=180.0/9.0;float S=3.0;vec4 operation(float y,float x){float my=y-(S*floor(y/S));float mx=x-(S*floor(x/S));x=x/S;y=y/S;float index=mx+(my*S);float sum=0.0;for(float dx=0.0;dx<K;dx+=1.0){for(float dy=0.0;dy<K;dy+=1.0){vec4 v=pickValue_tSrc(((y*K)+dy),((x*K)+dx));float theta=abs(PI/2.0-v.g);float deg=theta*(180.0/PI);float i=floor(deg/A);if(i==index){sum+=v.r;}}}float rad=(index/9.0*PI);return vec4(sum,rad,0.0,0.0);}").Compile({tSrc:t})}(gt(t),e)),a},t.imageTensorFromURL=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"uint8",n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new Promise((function(r,i){var o,s,l=G(),u=D(),c=u.getContext("2d");a&&(l.crossOrigin="anonymous"),l.onload=function(){var t;n?(o=n[1],s=n[0]):(o=l.width,s=l.height),u.width=o,u.height=s,c.drawImage(l,0,0,o,s);var a=c.getImageData(0,0,o,s);switch(e){case"uint8":t=new Uint8Array(a.data.buffer);break;case"float32":t=new Float32Array(a.data);break;default:t=a.data}var i=new it(e,[s,o,4],t);r(i)},l.onerror=i,l.src=t}))},t.initDrawable=function(t,e,n){var a=!1;return t.onmousedown=function(){a=!0},t.onmouseup=function(){a=!1},t.onmousemove=function(t){a&&(e.set(t.offsetY,t.offsetX,255),n&&n())},function(){t.onmousedown=null,t.onmouseup=null,t.onmousemove=null}},t.initMouseTracking=function(t,e){return t.onmousemove=function(t){return e(t.offsetX,t.offsetY)},function(){t.onmousemove=null}},t.invertTensor=function(){return F("invertTensor",'use "flipTensor" instead'),nt.apply(void 0,arguments)},t.isCanvasElement=L,t.isMediaInput=V,t.isOperation=A,t.isTensor=M,t.isValidGLSLChunk=O,t.isValidGLSLVariableName=U,t.isValidOperationShape=K,t.isValidShape=I,t.isVideoElement=R,t.kernels=vt,t.meanStd=Et,t.minMax=At,t.morphologyEx=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"open",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[2,2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case"open":return Kt(Ut(t,n,a),n,a);case"close":return Ut(Kt(t,n,a),n,a);case"gradient":return Dt(Kt(t,n,a),Ut(t,n,a));case"tophat":return Dt(t,Kt(Ut(t,n,a),n,a));case"blackhat":return Dt(Ut(Kt(t,n,a),n,a),t);default:return new Error("MorphTransform: unsopported operation type ".concat(e))}},t.motionDetect=function(t,e){return b(T(t,e),"MotionDetect: Current and previous input should have the same shape."),new Q("MotionDetect").Input("tCurr",t.dtype).Input("tPrev",e.dtype).Output(t.dtype).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 prev=pickValue_tPrev(y,x);vec4 curr=pickValue_tCurr(y,x);float v=sqrt((curr.x-prev.x)*(curr.x-prev.x)+(curr.y-prev.y)*(curr.y-prev.y)+(curr.w-prev.w)*(curr.w-prev.w));return vec4(v,v,v,1.0);}").Compile({tCurr:t,tPrev:e})},t.mult=function(t,e){var n="Mult";return Pt(n,t,e),new Q(n).Input("tA",t).Input("tB",e).Output(t.dtype).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);vec4 B=pickValue_tB(y,x);return vec4(A.rgb*B.rgb,1.0);}").Compile({tA:t,tB:e})},t.multScalar=function(t,e){var n="MultScalar";return Ft(n,t,e),new Q(n).Input("tA",t).Output(t.dtype).Uniform("uScalar","float",e).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);return vec4(A.rgb*uScalar,1.0);}").Compile({tA:t})},t.norm=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;b("l2"===e||"minmax"===e,"Unsupported type of normalization operation.\n     Currently availiable max and visualize.");var a=null;return"l2"===e&&(a=function(t,e){return new Q("l2Norm").Input("tSrc","uint8").Input("tStdMean","uint8").Output("uint8").LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec3 chanels=pickValue_tSrc(y,x).rgb;vec3 mean=pickValue_tStdMean(0.0,0.0).rgb;vec3 std=pickValue_tStdMean(1.0,0.0).rgb;vec3 value=(chanels-mean)/std;return vec4(value,1.0);}").Compile({tSrc:t,tStdMean:e})}(t,Et(t,n))),"minmax"===e&&(a=function(t,e){return new Q("minMaxNorm").Input("tSrc","uint8").Input("tMinMax","uint8").Output("uint8").LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec3 chanels=pickValue_tSrc(y,x).rgb;vec3 minV=pickValue_tMinMax(0.0,0.0).rgb;vec3 maxV=pickValue_tMinMax(1.0,0.0).rgb;vec3 value=(chanels-minV)/(maxV-minV);return vec4(value,1.0);}").Compile({tSrc:t,tMinMax:e})}(t,At(t,n))),a},t.pcLines=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,a=Ot(t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:2);a=Lt(a,n);for(var r=0;r<e;r+=1)a=Lt(a,n,1);return a},t.pcLinesEnhance=function(t){return new Q("PCLinesEnhanced").Input("tSrc","uint8").Output("uint8").Uniform("uWidth","float",t.shape[0]).Uniform("uHeight","float",t.shape[0]).LoadChunk("pickValue").GLSLKernel("\n#define X_STEPS 10.0\n#define Y_STEPS 10.0\nvec4 operation(float y,float x){float value=pickValue_tSrc(y,x).r;float c=value*value;float sum=0.0;for(float j=0.0;j<Y_STEPS;j+=1.0){for(float i=0.0;i<X_STEPS;i+=1.0){sum+=pickValue_tSrc((y-Y_STEPS/2.0)+j,(x-X_STEPS/2.0)+i).r;}}float v=(c/sum)*X_STEPS*Y_STEPS;return vec4(v,v,v,1);}").Compile({tSrc:t})},t.pcLinesReduceMax=Lt,t.pcLinesTransform=Ot,t.perspectiveProjection=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[10,10,4],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.dtype;return new Q("PerspectiveProjection").Input("tSrc",t.dtype).Input("tTransform","float32").Output(a).LoadChunk("pickValue").Uniform("uSrcWidth","float",t.shape[1]).Uniform("uSrcHeight","float",t.shape[0]).Uniform("uWidth","float",n[1]).Uniform("uHeight","float",n[0]).SetShapeFn((function(){return n})).GLSLKernel("vec4 getPoint(vec2 p){return pickValue_tSrc(p.y,p.x);}mat3 getTransformMatrix(){vec3 r1=pickValue_tTransform(0.0,0.0).rgb;vec3 r2=pickValue_tTransform(1.0,0.0).rgb;vec3 r3=pickValue_tTransform(3.0,0.0).rgb;return mat3(r1,r2,r3);}vec4 operation(float y,float x){mat3 m=getTransformMatrix();float off=0.0;float ixs=0.0;float iys=0.0;float xs=0.0;float ys=0.0;float xs0=0.0;float ys0=0.0;float ws=0.0;float sc=0.0;float a=0.0;float b=0.0;xs0=m[0][1]*y+m[0][2];ys0=m[1][1]*y+m[1][2];ws=m[2][1]*y+m[2][2];xs0+=m[0][0]*x;ys0+=m[1][0]*x;ws+=m[2][0]*x;sc=1.0/ws;xs=xs0*sc;ys=ys0*sc;ixs=xs;iys=ys;a=max(xs-ixs,0.0);b=max(ys-iys,0.0);vec2 mvec=vec2(ixs,iys);vec2 ox=vec2(1.0,0.0);vec2 oy=vec2(1.0,1.0);vec4 p0=getPoint(mvec)+a*(getPoint(mvec+ox)-getPoint(mvec));vec4 p1=getPoint(mvec+oy)+a*(getPoint(mvec+ox+oy)-getPoint(mvec+oy));vec4 pres=p0+b*(p1-p0);return pres;}").Compile({tSrc:t,tTransform:e})},t.putImageData=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:e.width,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:e.height,l=arguments.length>8?arguments[8]:void 0;return(e.width!==t.width||e.height!==t.height||l)&&t.getContext("2d").clearRect(0,0,t.width,t.height),t.getContext("2d").putImageData(e,n,a,r,i,o,s)},t.range=tt,t.resize=yt,t.sat=Wt,t.skinTest=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Q("SkinTest").Input("tSrc",t.dtype).Output(t.dtype).Uniform("uRThreshold","float",e.uRThreshold||95).Uniform("uGThreshold","float",e.uGThreshold||40).Uniform("uBThreshold","float",e.uBThreshold||20).Uniform("uRtoMinDiffThreshold","float",e.uRtoMinDiffThreshold||15).Uniform("uRtoGDiffThreshold","float",e.uRtoGDiffThreshold||15).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 col=pickValue_tSrc(y,x)*255.0;float res=0.0;if((col.r>uRThreshold)&&(col.g>uGThreshold)&&(col.b>uBThreshold)&&(col.r>col.g)&&(col.r>col.b)&&(col.r-min(col.g,col.b)>uRtoMinDiffThreshold)&&(abs(col.r-col.g)>uRtoGDiffThreshold)){res=1.0;}return vec4(res,0.0,0.0,1.0);}").Compile({tSrc:t})},t.slidingWindow=function(t,e){var n,a,r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=Rt(e,"windowSize"),l=Rt(i,"stride"),u=bt(t.shape[1],s[0],l[0]),c=bt(t.shape[0],s[1],l[1]);switch(o){case 1:n=[u*c,s[0]*s[1],4],r=!0,a=Vt;break;case 2:n=[1,u*c*s[0]*s[1],4],r=!1,a=Mt;break;case 3:n=[u*c*s[0]*s[1],1,4],r=!0,a=Mt;break;default:n=[s[0]*s[1],u*c,4],r=!1,a=Vt}return new Q("SlidingWindow").Input("tSrc","float32").Output("float32").Constant("WIDTH",t.shape[1]).Constant("HEIGHT",t.shape[0]).Constant("SX",u).Constant("SY",c).Constant("STRIDE_Y",l[1]).Constant("STRIDE_X",l[0]).Constant("WIN_SIZE_X",s[0]).Constant("WIN_SIZE_Y",s[1]).Constant("SWAP_COORDS",r).LoadChunk("pickValue").SetShapeFn((function(){return n})).GLSLKernel(a).Compile({tSrc:t})},t.sobelOperator=function(t){return new Q("SobelOperator").Input("tSrc",t.dtype).Output("float32").Uniform("uWidth","float",t.shape[0]).Uniform("uHeight","float",t.shape[1]).Constant("PI",Math.PI).GLSLKernel("vec4 operation(float y,float x){float wk=1.0;float hk=1.0;float dx=0.0;float dy=0.0;dx+=-1.0*pickScalarValue_tSrc(y-hk,x-wk);dx+=-2.0*pickScalarValue_tSrc(y,x-wk);dx+=-1.0*pickScalarValue_tSrc(y+wk,x-wk);dx+=+1.0*pickScalarValue_tSrc(y-wk,x+wk);dx+=+2.0*pickScalarValue_tSrc(y,x+wk);dx+=+1.0*pickScalarValue_tSrc(y+wk,x+wk);dy+=-1.0*pickScalarValue_tSrc(y-wk,x-wk);dy+=-2.0*pickScalarValue_tSrc(y-wk,x);dy+=-1.0*pickScalarValue_tSrc(y-wk,x+wk);dy+=+1.0*pickScalarValue_tSrc(y+wk,x-wk);dy+=+2.0*pickScalarValue_tSrc(y+wk,x);dy+=+1.0*pickScalarValue_tSrc(y+wk,x+wk);float magniture=sqrt((dx*dx)+(dy*dy));float theta=atan(dy/dx);return vec4(magniture,dx,dy,theta);}").LoadChunk("pickValue").Compile({tSrc:t})},t.sqsat=function(t){return Ht(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,!0)},t.sub=Dt,t.subScalar=function(t,e){var n="SubScalar";return Ft(n,t,e),new Q(n).Input("tA",t).Output(t.dtype).Uniform("uScalar","float",e).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 A=pickValue_tA(y,x);return vec4(A.rgb-uScalar,1.0);}").Compile({tA:t})},t.swt=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10,i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];return new Q("ImageStrokeWidthTransform").Input("tSobel","float32").Input("tCanny","uint8").Output("float32").LoadChunk("pickValue").Uniform("uStrokeMin","float",n).Uniform("uStrokeMax","float",a).Uniform("uWidth","float",t.shape[0]).Uniform("uHeight","float",t.shape[1]).Constant("STEPS",r).Constant("C",i?1:0).Constant("INVERT",o?1:0).Constant("PI",Math.PI).GLSLKernel("vec4 findForAngle(float theta,bool invert,float gly,float glx){const float thetaTreshold=PI/6.0;float PER_STEP=(uStrokeMax-uStrokeMin)/STEPS;if(invert){theta+=PI;}float sn=sin(theta);float cs=cos(theta);float tx=cs*PER_STEP;float ty=sn*PER_STEP;float minX=cs*uStrokeMin;float minY=sn*uStrokeMin;float strokeWidth=0.0;int intersect=0;int cx=0;int cy=0;for(int i=int(STEPS);i>0;i-=1){int nx=int(glx+minX+tx*float(i));int ny=int(gly+minY+ty*float(i));float dist=sqrt(float((nx-int(glx))*(nx-int(glx)))+float((ny-int(gly))*(ny-int(gly))));float cannyValue=pickValue_tCanny(float(ny),float(nx)).r;vec4 sobelValue=pickValue_tSobel(float(ny),float(nx));float theta2=atan(sobelValue.b,sobelValue.g);if(invert){theta2+=PI;}if(cannyValue>0.0&&dist>uStrokeMin&&dist<uStrokeMax&&abs(abs(theta-theta2)-PI)<thetaTreshold){strokeWidth=dist;cx=nx;cy=ny;}}return vec4(strokeWidth,cx,cy,theta);}vec4 operation(float _y,float _x){vec4 sobel=pickValue_tSobel(_y,_x);vec4 canny=pickValue_tCanny(_y,_x);float dx=sobel.g;float dy=sobel.b;float _theta=atan(dy,dx);vec4 result=findForAngle(_theta,INVERT>0.0,_y,_x);float strokeWidth=result.r;int cx=int(result.g);int cy=int(result.b);float theta=result.a;float a=float(cx)-_x;float b=float(cy)-_y;if(C>0.0){if(canny.r>0.0&&cx>0&&cy>0){return vec4(strokeWidth,theta,int(cx),int(cy));}else{return vec4(0,0,0,0);}}if(canny.r>0.0&&cx>0&&cy>0){return vec4(strokeWidth,theta,0,1.0);}else{return vec4(0,0,0,0);}}").Compile({tCanny:e,tSobel:t})},t.tensorAssertCloseEqual=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(!T(t,e))return!1;for(var a=0;a<t.size;a+=1)if(Math.abs(t.data[a]-e.data[a])>n)return!1;return!0},t.tensorAssertEqual=function(t,e){if(!T(t,e))return!1;for(var n=0;n<t.size;n+=1)if(t.data[n]!==e.data[n])return!1;return!0},t.tensorAssertMSEEqual=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(!T(t,e))return!1;for(var a=0,r=0;r<t.size;r+=1)a+=Math.pow(t.data[r]-e.data[r],2);return(a=Math.sqrt(a)/t.size)<n},t.tensorClone=et,t.tensorFrom=function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=null;return A(t)&&(n=new it(e||t.dtype,t.shape)),M(t)&&(n=new it(e||t.dtype,t.shape)),V(t)&&(n=new it(e||t.dtype,t.shape)),n},t.tensorFromFlat=rt,t.tensorInvert=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Array(t.shape.length).fill(!0),a=t.shape;if(t===e&&(t=t.clone()),t.shape.length!==e.shape.length)throw new Error("invertTensor: Unable to invert, input and output has different shapes");for(var r=new Array(a.length),i=new Function("coords","tmpArr","shape","".concat(n.map((function(t,e){return t?"tmpArr[".concat(e,"] = shape[").concat(e,"] - 1 - coords[").concat(e,"]"):"tmpArr[".concat(e,"] = coords[").concat(e,"]")})).join(";"),"; return tmpArr;")),o=0;o<t.size;o+=1){var s,l=it.IndexToCoord(a,o),u=i(l,r,a);e.set.apply(e,d(u).concat([(s=t).get.apply(s,d(l))]))}return e},t.tensorMap=at,t.tensorOnes=function(t,e){var n=new it(t,e);return at(n,(function(){return 1})),n},t.threshold=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return b("number"==typeof e,"Only number available as a threshold value."),b(0===n||1===n||2===n||3===n,"Only RGBA available: 0, 1, 2, 3"),new Q("Threshold").Input("tSrc",t.dtype).Output(t.dtype).Constant("C",n).Uniform("uT","float",e).LoadChunk("pickValue").GLSLKernel("vec4 operation(float y,float x){vec4 pixel=pickValue_tSrc(y,x);if(pixel[int(C)]>uT){return vec4(1.0,1.0,1.0,1.0);}else{return vec4(0.0,0.0,0.0,1.0);}}").Compile({tSrc:t})},t.toImageData=st,t.upsample=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nearest",a=~~(t.shape[1]*e),r=~~(t.shape[0]*e);return yt(t,a,r,n)}})),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t)}(this,(function(t){t.gm=t.GammaCV}));
